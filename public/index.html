<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Manager - Qu·∫£n L√Ω M√°y Ch∆°i Game</title>
    
    <!-- PWA Meta Tags cho iPhone -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Game Manager">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    
    <!-- iPhone/iPad Splash Screens -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-startup-image" href="/icons/splash-2048x2732.svg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1668x2388.svg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1536x2048.svg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1284x2778.svg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1170x2532.svg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1125x2436.svg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-828x1792.svg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-750x1334.svg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    
    <!-- Apple Touch Icons cho t·∫•t c·∫£ devices - PNG format cho iOS -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/icons/icon-57x57.png">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Machine Selector Styles */
        .machine-selector {
            position: relative;
        }

        .machine-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .machine-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }

        .machine-option:hover {
            background-color: #f8f9fa;
        }

        .machine-option:last-child {
            border-bottom: none;
        }

        .machine-option.selected {
            background-color: #667eea;
            color: white;
        }

        .machine-option .machine-name {
            font-weight: bold;
            color: #333;
        }

        .machine-option.selected .machine-name {
            color: white;
        }

        .machine-option .machine-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
        }

        .machine-option.selected .machine-details {
            color: #e9ecef;
        }

        .selected-machine {
            margin-top: 10px;
            padding: 12px 15px;
            background: #e8f4fd;
            border: 1px solid #667eea;
            border-radius: 8px;
            font-weight: bold;
            color: #0d47a1;
        }

        .selected-machine .clear-selection {
            float: right;
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            padding: 0;
            margin: 0;
        }

        /* Mobile layout t·ªëi ∆∞u - g·ªçn g√†ng v√† ngang */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                overflow-x: hidden;
                /* iPhone specific optimizations */
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Fix for iPhone safe areas */
            .container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            
            .container {
                max-width: 100%;
                padding: 8px;
            }
            
            .header {
                margin-bottom: 15px;
            }
            
            .header-title h1 {
                font-size: 1.6em !important;
                margin-bottom: 8px !important;
            }
            
            .header-content {
                flex-direction: column !important;
                gap: 15px !important;
            }
            
            .header-user {
                padding: 12px 15px !important;
                text-align: center !important;
                border-radius: 12px !important;
                width: 100% !important;
            }
            
            .header-user h3 {
                font-size: 1em !important;
                margin-bottom: 5px !important;
            }
            
            .header-user p {
                font-size: 0.9em !important;
                margin-bottom: 8px !important;
            }
            
            .btn-logout {
                padding: 8px 15px !important;
                font-size: 14px !important;
                width: 100% !important;
            }

            /* T·ªëi ∆∞u form cho mobile */
            .form-group {
                margin-bottom: 20px !important;
            }

            .form-group label {
                font-size: 1.1em !important;
                font-weight: 600 !important;
                margin-bottom: 8px !important;
            }

            .form-group input, .form-group select, .form-group textarea {
                font-size: 16px !important; /* NgƒÉn zoom tr√™n iPhone */
                padding: 15px !important;
                border-radius: 10px !important;
                height: auto !important;
            }

            .machine-dropdown {
                font-size: 16px;
            }

            .machine-option {
                padding: 15px 12px;
                font-size: 16px;
            }

            .btn {
                font-size: 16px !important;
                padding: 15px 20px !important;
                border-radius: 12px !important;
                width: 100% !important;
                margin-bottom: 10px !important;
            }

            /* Tab navigation cho mobile */
            .tab-nav {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 5px !important;
                margin-bottom: 20px !important;
            }

            .tab-nav button {
                flex: 1 !important;
                min-width: 0 !important;
                font-size: 14px !important;
                padding: 12px 8px !important;
                border-radius: 8px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            color: white;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            text-align: left;
        }

        .header-title h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-user {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 15px;
            text-align: right;
        }

        .header-user h3 {
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .header-user p {
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* History Summary Styles */
        .history-summary {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .summary-card h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.5em;
        }

        .summary-card p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        /* Improved Transaction Item Styles */
        .transaction-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .transaction-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.1em;
        }

        .transaction-info .meta {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .transaction-amount {
            text-align: right;
        }

        .transaction-amount .revenue {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .transaction-amount .coins {
            font-size: 0.9em;
            color: #666;
        }

        .transaction-footer {
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .transaction-footer span {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .late-entry-warning {
            color: #ff6b35 !important;
            background: #fff3cd !important;
            border-color: #ffeaa7 !important;
            font-weight: bold;
        }

        .date-group {
            background: #f8f9fa;
            padding: 10px 15px;
            margin: 20px 0 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .date-group h3 {
            margin: 0;
            color: #333;
            font-size: 1.1em;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            background: #f8f9fa;
            color: #ccc;
            cursor: not-allowed;
        }

        .pagination span {
            color: #666;
            font-size: 0.9em;
        }

        .tab-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab-content {
            padding: 30px;
            min-height: 400px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Quick Filter Buttons Styles */
        .quick-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-color: #2196f3 !important;
        }

        .quick-filter-btn.active {
            background: #e3f2fd !important;
            border-color: #2196f3 !important;
            border-width: 3px !important;
        }

        .quick-filter-btn.active div:nth-child(2) {
            color: #1976d2 !important;
        }

                 /* Mobile responsive cho quick filters */
        @media (max-width: 768px) {
            .quick-filter-buttons {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .quick-filter-btn {
                padding: 10px 6px !important;
                font-size: 0.8em !important;
            }
            
            .quick-filter-btn div:first-child {
                font-size: 1.2em !important;
            }
            
            .quick-filter-btn div:nth-child(2) {
                font-size: 0.9em !important;
                margin: 3px 0 !important;
            }
            
            .quick-filter-btn div:last-child {
                font-size: 0.7em !important;
            }

            /* Action buttons responsive */
            .action-buttons {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .action-buttons > div {
                flex: none !important;
                width: 100% !important;
                text-align: left !important;
            }
            
            .action-buttons button {
                width: 100% !important;
                min-width: auto !important;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Mobile responsive cho stats-grid */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 15px;
                min-height: 80px;
            }
            
            .stat-card h3 {
                font-size: 1.2rem;
                margin-bottom: 5px;
            }
            
            .stat-card p {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 6px !important;
            }
            
            .stat-card {
                padding: 8px 4px !important;
                min-height: 70px !important;
            }
            
            .stat-card h3 {
                font-size: 1rem !important;
                margin-bottom: 2px !important;
            }
            
            .stat-card p {
                font-size: 0.65rem !important;
                line-height: 1.1 !important;
            }
        }

        /* ƒê·∫∑c bi·ªát cho iPhone v√† thi·∫øt b·ªã di ƒë·ªông - hi·ªÉn th·ªã n·∫±m ngang nh∆∞ laptop */
        @media screen and (max-width: 767px) {
            .stats-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                grid-template-rows: auto !important;
                gap: 8px !important;
                width: 100% !important;
                margin-bottom: 20px !important;
            }
            
            .stat-card {
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                min-height: 80px !important;
                max-width: none !important;
                width: 100% !important;
                box-sizing: border-box !important;
                padding: 10px 5px !important;
            }
            
            .stat-card h3 {
                font-size: 1.2rem !important;
                margin-bottom: 4px !important;
                line-height: 1.1 !important;
            }
            
            .stat-card p {
                font-size: 0.7rem !important;
                line-height: 1.2 !important;
                text-align: center !important;
                margin: 0 !important;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .machine-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .machine-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid transparent;
        }

        .machine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .machine-item[data-revenue="positive"] {
            border-left-color: #28a745;
        }

        .machine-item[data-revenue="negative"] {
            border-left-color: #dc3545;
        }

        .machine-item[data-revenue="zero"] {
            border-left-color: #6c757d;
        }

        .transaction-history {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .transaction-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters > div {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 8px 0;
            }
            
            .header-title h1 {
                font-size: 1.4rem;
            }
            
            .header-title p {
                font-size: 0.9rem !important;
                margin-bottom: 0 !important;
            }
            
            .tab-container {
                margin-top: 10px;
            }
            
            .tabs {
                flex-wrap: nowrap;
                gap: 2px;
            }
            
            .tab {
                flex: 1;
                min-width: 80px;
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            
            .tab-content {
                padding: 15px !important;
                min-height: auto !important;
            }
            
            .tab-content h2 {
                font-size: 1.2rem !important;
                margin-bottom: 10px !important;
            }
            
            .filters {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .filters .form-group {
                flex: 1;
                min-width: 150px;
                margin-bottom: 8px;
            }
            
            .form-group {
                width: 100%;
                margin-bottom: 12px;
            }
            
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 4px;
            }
            
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px;
                font-size: 16px; /* NgƒÉn zoom tr√™n iOS */
                border-radius: 8px;
            }
            
            .form-group small {
                font-size: 0.8rem;
                line-height: 1.2;
            }
            
            .btn {
                width: 100%;
                padding: 10px;
                font-size: 0.95rem;
                margin-top: 8px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .machine-item {
                padding: 8px;
                margin-bottom: 6px;
                font-size: 0.85rem;
            }
            
            .transaction-item {
                padding: 8px;
                font-size: 0.85rem;
                margin-bottom: 6px;
            }

            /* Compact layout cho mobile */
            .machine-list {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }
            
            .transaction-history {
                max-height: 300px !important;
                padding: 10px !important;
            }
            
            /* Machine item compact */
            .machine-item h4 {
                font-size: 0.9rem !important;
                margin-bottom: 2px !important;
            }
            
            .machine-item .revenue {
                font-size: 1rem !important;
            }
            
            .machine-item small {
                font-size: 0.75rem !important;
                line-height: 1.1 !important;
            }
            
            /* Transaction item compact */
            .transaction-header {
                margin-bottom: 6px !important;
            }
            
            .transaction-info h4 {
                font-size: 0.9rem !important;
                margin-bottom: 2px !important;
            }
            
            .transaction-info .meta {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
            }
            
            .transaction-amount .revenue {
                font-size: 1rem !important;
            }
            
            .transaction-amount .coins {
                font-size: 0.75rem !important;
            }
            
            .transaction-footer {
                padding-top: 4px !important;
                margin-top: 4px !important;
                font-size: 0.75rem !important;
            }
            
            .date-group {
                padding: 6px 10px !important;
                margin: 10px 0 6px 0 !important;
                font-size: 0.9rem !important;
            }
            
            /* T·ªëi ∆∞u grid layout cho results */
            .stats-grid {
                margin-bottom: 10px !important;
            }
            
            /* Touch-friendly buttons */
            .tab,
            .btn,
            button {
                min-height: 40px;
                -webkit-tap-highlight-color: transparent;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>üéÆ Qu·∫£n L√Ω M√°y Ch∆°i Game</h1>
                    <p>H·ªá th·ªëng theo d√µi xu v√†o/ra v√† doanh thu</p>
                </div>
                <div class="header-user" id="header-user">
                    <!-- User info s·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
                </div>
            </div>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('entry')">Nh·∫≠p Li·ªáu</button>
                <button class="tab" onclick="showTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="showTab('history')">L·ªãch S·ª≠</button>
            </div>

            <!-- Tab Nh·∫≠p Li·ªáu -->
            <div id="entry" class="tab-content">
                <h2>üìä Nh·∫≠p D·ªØ Li·ªáu Xu</h2>
                <div id="alert-container"></div>
                
                <form id="transactionForm">
                    <div class="form-group" id="branch_selector" style="display: none;">
                        <label for="form_branch_id">Ch·ªçn Chi Nh√°nh:</label>
                        <select id="form_branch_id">
                            <option value="">-- Ch·ªçn chi nh√°nh --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="machine_id">Ch·ªçn M√°y:</label>
                        <div class="machine-selector">
                            <input type="text" id="machine_search" placeholder="üîç T√¨m m√°y (VD: 001, T·∫ßng 1)..." autocomplete="off">
                            <select id="machine_id" required style="display: none;">
                                <option value="">-- Ch·ªçn m√°y ch∆°i game --</option>
                            </select>
                            <div id="machine_dropdown" class="machine-dropdown" style="display: none;"></div>
                        </div>
                        <div id="selected_machine" class="selected-machine" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label for="transaction_date">Ng√†y Giao D·ªãch:</label>
                        <input type="date" id="transaction_date" required>
                        <small style="color: #666; font-size: 0.9em;">üí° Ch·ªçn ng√†y th·ª±c hi·ªán giao d·ªãch (c√≥ th·ªÉ l√† h√¥m qua n·∫øu qu√™n nh·∫≠p)</small>
                    </div>

                    <div class="form-group">
                        <label for="coins_in">üí∞ Coin In Total (Xu V√†o):</label>
                        <input type="number" id="coins_in" min="0" value="0" required placeholder="VD: 70200" oninput="calculateProfit()">
                        <small style="color: #666;">T·ªïng s·ªë xu kh√°ch n·∫°p v√†o m√°y</small>
                    </div>

                    <div class="form-group">
                        <label for="coins_out">üí∏ Coin Out Total (Xu Ra):</label>
                        <input type="number" id="coins_out" min="0" value="0" required placeholder="VD: 57000" oninput="calculateProfit()">
                        <small style="color: #666;">T·ªïng s·ªë xu kh√°ch th·∫Øng ƒë∆∞·ª£c</small>
                    </div>

                    <div class="form-group">
                        <label for="profit_display">üìä Total Profit (L√£i/L·ªó):</label>
                        <input type="text" id="profit_display" readonly style="background: #f8f9fa; font-weight: bold; font-size: 1.1em;" placeholder="T·ª± ƒë·ªông t√≠nh = Xu V√†o - Xu Ra">
                        <small style="color: #666;">ƒê∆∞·ª£c t√≠nh t·ª± ƒë·ªông khi nh·∫≠p xu v√†o/ra</small>
                    </div>

                    <div class="form-group">
                        <label for="note">üìù Ghi Ch√∫ (t√πy ch·ªçn):</label>
                        <input type="text" id="note" placeholder="VD: Ca s√°ng, ca chi·ªÅu, m√°y b√°o l·ªói, th√¥ng tin ƒë·∫∑c bi·ªát...">
                        <small style="color: #666;">üí° Ghi ch√∫ th√™m th√¥ng tin nh∆∞ ca l√†m vi·ªác, t√¨nh tr·∫°ng m√°y, v.v.</small>
                    </div>

                    <button type="submit" class="btn">üíæ L∆∞u Giao D·ªãch</button>
                    <a href="/guide.html" target="_blank" class="btn" style="background: #17a2b8; text-decoration: none; display: inline-block; margin-left: 10px;">üìñ H∆∞·ªõng D·∫´n Nh·∫≠p Li·ªáu</a>
                </form>
            </div>

            <!-- Tab Dashboard -->
            <div id="dashboard" class="tab-content" style="display: none;">
                <h2>üìà Dashboard Doanh Thu</h2>
                
                <!-- Quick Filter Buttons -->
                <div class="quick-filters" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #e9ecef;">
                    <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 1.1em;">‚ö° Xem Nhanh</h3>
                    <div class="quick-filter-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <button class="quick-filter-btn" data-period="today" onclick="setQuickFilter('today')" style="padding: 12px 8px; border-radius: 8px; border: 2px solid #e9ecef; background: #fff; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em;">
                            <div style="font-size: 1.4em;">üïê</div>
                            <div style="font-weight: bold; margin: 5px 0;">H√îM NAY</div>
                            <div style="font-size: 0.8em; color: #6c757d;" id="today-date"></div>
                        </button>
                        <button class="quick-filter-btn" data-period="yesterday" onclick="setQuickFilter('yesterday')" style="padding: 12px 8px; border-radius: 8px; border: 2px solid #e9ecef; background: #fff; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em;">
                            <div style="font-size: 1.4em;">üìÖ</div>
                            <div style="font-weight: bold; margin: 5px 0;">H√îM QUA</div>
                            <div style="font-size: 0.8em; color: #6c757d;" id="yesterday-date"></div>
                        </button>
                        <button class="quick-filter-btn" data-period="week" onclick="setQuickFilter('week')" style="padding: 12px 8px; border-radius: 8px; border: 2px solid #e9ecef; background: #fff; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em;">
                            <div style="font-size: 1.4em;">üìä</div>
                            <div style="font-weight: bold; margin: 5px 0;">7 NG√ÄY QUA</div>
                            <div style="font-size: 0.8em; color: #6c757d;" id="week-date"></div>
                        </button>
                        <button class="quick-filter-btn" data-period="month" onclick="setQuickFilter('month')" style="padding: 12px 8px; border-radius: 8px; border: 2px solid #e9ecef; background: #fff; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em;">
                            <div style="font-size: 1.4em;">üìà</div>
                            <div style="font-weight: bold; margin: 5px 0;">TH√ÅNG N√ÄY</div>
                            <div style="font-size: 0.8em; color: #6c757d;" id="month-date"></div>
                        </button>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="loadDashboard()" style="background: #667eea; flex: 1; min-width: 120px;">
                        üîç C·∫≠p Nh·∫≠t B√°o C√°o
                    </button>
                    <div id="export_section" style="display: none;">
                        <button type="button" class="btn" onclick="exportCurrentData()" style="background: #28a745; min-width: 140px;">
                            üìÑ Export Excel
                        </button>
                    </div>
                    <div id="reset_section" style="display: none;">
                        <button type="button" class="btn" onclick="resetData()" style="background: #dc3545; min-width: 120px;">
                            üóëÔ∏è Reset D·ªØ Li·ªáu
                        </button>
                    </div>
                    <div style="flex: 1; text-align: right;">
                        <button type="button" id="toggle-advanced" onclick="toggleAdvancedFilters()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            üîß B·ªô L·ªçc N√¢ng Cao <span id="toggle-icon">‚ñº</span>
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Filters (Collapsed by default) -->
                <div class="advanced-filters" style="margin-bottom: 20px;">
                    <div id="advanced-filter-content" class="filters" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div class="form-group" id="dashboard_branch_selector" style="display: none;">
                        <label for="dashboard_branch_id">Chi Nh√°nh:</label>
                        <select id="dashboard_branch_id">
                            <option value="">-- T·∫•t c·∫£ chi nh√°nh --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="start_date">T·ª´ Ng√†y:</label>
                        <input type="date" id="start_date">
                    </div>
                    <div class="form-group">
                        <label for="end_date">ƒê·∫øn Ng√†y:</label>
                        <input type="date" id="end_date">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn" onclick="loadDashboard()">üîç √Åp D·ª•ng B·ªô L·ªçc</button>
                    </div>
                    </div>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <!-- Stats s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
                </div>

                <div class="machine-list" id="machine-revenue">
                    <!-- Doanh thu theo m√°y s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
                </div>
            </div>

            <!-- Tab L·ªãch S·ª≠ -->
            <div id="history" class="tab-content" style="display: none;">
                <h2>üìã L·ªãch S·ª≠ Giao D·ªãch</h2>
                <div id="admin_info" style="display: none; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <strong>üîë Ch·∫ø ƒë·ªô Admin:</strong> B·∫°n c√≥ th·ªÉ xem th√¥ng tin chi ti·∫øt v·ªÅ th·ªùi gian nh·∫≠p li·ªáu v√† ng√†y giao d·ªãch c·ªßa t·∫•t c·∫£ chi nh√°nh. 
                    S·ª≠ d·ª•ng c√°c filter ƒë·ªÉ t√¨m ki·∫øm theo chi nh√°nh, nh√¢n vi√™n, ho·∫∑c giao d·ªãch nh·∫≠p mu·ªôn.
                    <button onclick="debugTransactions()" style="margin-left: 15px; background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">üîß Debug Data</button>
                    <button onclick="createTestData()" style="margin-left: 5px; background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚ûï T·∫°o Test Data</button>
                </div>
                
                <div class="filters">
                    <div class="form-group" id="history_branch_selector" style="display: none;">
                        <label for="history_branch_id">Chi Nh√°nh:</label>
                        <select id="history_branch_id">
                            <option value="">-- T·∫•t c·∫£ chi nh√°nh --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter_machine">L·ªçc Theo M√°y:</label>
                        <select id="filter_machine">
                            <option value="">-- T·∫•t c·∫£ m√°y --</option>
                        </select>
                    </div>
                    <div class="form-group" id="history_user_selector" style="display: none;">
                        <label for="history_user_id">Nh√¢n Vi√™n:</label>
                        <select id="history_user_id">
                            <option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="history_start_date">T·ª´ Ng√†y:</label>
                        <input type="date" id="history_start_date">
                    </div>
                    <div class="form-group">
                        <label for="history_end_date">ƒê·∫øn Ng√†y:</label>
                        <input type="date" id="history_end_date">
                    </div>
                    <div class="form-group">
                        <label for="sort_by">S·∫Øp X·∫øp:</label>
                        <select id="sort_by">
                            <option value="date_desc">Ng√†y m·ªõi nh·∫•t</option>
                            <option value="date_asc">Ng√†y c≈© nh·∫•t</option>
                            <option value="revenue_desc">Doanh thu cao nh·∫•t</option>
                            <option value="revenue_asc">Doanh thu th·∫•p nh·∫•t</option>
                        </select>
                    </div>
                    <div class="form-group" id="late_entry_filter" style="display: none;">
                        <label for="filter_late_entry">L·ªçc Nh·∫≠p Mu·ªôn:</label>
                        <select id="filter_late_entry">
                            <option value="">-- T·∫•t c·∫£ --</option>
                            <option value="late">Ch·ªâ nh·∫≠p mu·ªôn ‚ö†Ô∏è</option>
                            <option value="ontime">Ch·ªâ nh·∫≠p ƒë√∫ng gi·ªù ‚úÖ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn" onclick="loadTransactions()">üîç T√¨m Ki·∫øm</button>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn" onclick="clearHistoryFilters()" style="background: #6c757d;">üóëÔ∏è X√≥a Filter</button>
                    </div>
                </div>

                <!-- Summary stats cho l·ªãch s·ª≠ -->
                <div class="history-summary" id="history-summary" style="display: none;">
                    <!-- Summary s·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
                </div>

                <div class="transaction-history" id="transaction-history">
                    <!-- L·ªãch s·ª≠ giao d·ªãch s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination" style="display: none;">
                    <!-- Pagination s·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = '';
        
        // Global user data
        let currentUser = null;

        // Load trang
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        // T√≠nh to√°n profit t·ª± ƒë·ªông
        function calculateProfit() {
            const coinsIn = parseInt(document.getElementById('coins_in').value) || 0;
            const coinsOut = parseInt(document.getElementById('coins_out').value) || 0;
            const profit = coinsIn - coinsOut;
            
            const profitDisplay = document.getElementById('profit_display');
            if (coinsIn > 0 || coinsOut > 0) {
                profitDisplay.value = `${profit} xu`;
                
                // ƒê·ªïi m√†u theo profit
                if (profit > 0) {
                    profitDisplay.style.color = '#28a745'; // Xanh = l√£i
                    profitDisplay.style.background = '#d4edda';
                } else if (profit < 0) {
                    profitDisplay.style.color = '#dc3545'; // ƒê·ªè = l·ªó
                    profitDisplay.style.background = '#f8d7da';
                } else {
                    profitDisplay.style.color = '#6c757d'; // X√°m = h√≤a v·ªën
                    profitDisplay.style.background = '#f8f9fa';
                }
            } else {
                profitDisplay.value = '';
                profitDisplay.style.color = '#333';
                profitDisplay.style.background = '#f8f9fa';
            }
        }

        // Ki·ªÉm tra authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/profile', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    initializeApp();
                } else {
                    // Ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn ƒë·∫øn trang login
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login.html';
            }
        }

        // Kh·ªüi t·∫°o app sau khi ƒë√£ auth
        function initializeApp() {
            updateUIForUserRole();
            loadBranches();
            loadMachines();
            loadDashboard();
            setDefaultDates();
        }

        // C·∫≠p nh·∫≠t UI theo role ng∆∞·ªùi d√πng
        function updateUIForUserRole() {
            if (!currentUser) return;

            // C·∫≠p nh·∫≠t header user info
            const headerUser = document.getElementById('header-user');
            headerUser.innerHTML = `
                <h3>${currentUser.full_name}</h3>
                <p>${getRoleDisplayName(currentUser.role)}${currentUser.branch_name ? ' - ' + currentUser.branch_name : ''}</p>
                <button class="btn-logout" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
            `;

            // Hi·ªÉn th·ªã/·∫©n c√°c element theo role
            if (currentUser.role === 'admin') {
                // Admin th·∫•y t·∫•t c·∫£
                document.getElementById('branch_selector').style.display = 'block';
                document.getElementById('dashboard_branch_selector').style.display = 'block';
                document.getElementById('history_branch_selector').style.display = 'block';
                document.getElementById('history_user_selector').style.display = 'block';
                document.getElementById('export_section').style.display = 'block';
                document.getElementById('late_entry_filter').style.display = 'block';
                document.getElementById('admin_info').style.display = 'block';
                loadUsers(); // Load danh s√°ch t·∫•t c·∫£ users cho admin
            } else if (currentUser.role === 'manager') {
                // Manager ch·ªâ th·∫•y chi nh√°nh m√¨nh v√† c√≥ th·ªÉ export, reset
                document.getElementById('export_section').style.display = 'block';
                document.getElementById('reset_section').style.display = 'block';
                document.getElementById('history_user_selector').style.display = 'block';
                document.getElementById('late_entry_filter').style.display = 'block';
                
                // Hi·ªÉn th·ªã th√¥ng tin ƒë·∫∑c bi·ªát cho manager
                const managerInfo = document.getElementById('admin_info');
                if (managerInfo) {
                    managerInfo.style.display = 'block';
                    managerInfo.innerHTML = `
                        <strong>üè¢ Ch·∫ø ƒë·ªô Manager - ${currentUser.branch_name}:</strong> 
                        B·∫°n c√≥ th·ªÉ xem th√¥ng tin chi ti·∫øt v·ªÅ th·ªùi gian nh·∫≠p li·ªáu v√† ng√†y giao d·ªãch c·ªßa nh√¢n vi√™n trong chi nh√°nh. 
                        S·ª≠ d·ª•ng filter "L·ªçc Nh·∫≠p Mu·ªôn" ƒë·ªÉ ki·ªÉm tra nh√¢n vi√™n n√†o nh·∫≠p d·ªØ li·ªáu mu·ªôn.
                        <button onclick="debugTransactions()" style="margin-left: 15px; background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">üîß Debug Data</button>
                        <button onclick="createTestData()" style="margin-left: 5px; background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚ûï T·∫°o Test Data</button>
                    `;
                }
                
                loadUsers(); // Load danh s√°ch nh√¢n vi√™n cho manager
            } else {
                // Employee ch·ªâ nh·∫≠p li·ªáu
                const dashboard = document.querySelector('.tab[onclick="showTab(\'dashboard\')"]');
                if (dashboard) dashboard.style.display = 'none';
            }
        }

        function getRoleDisplayName(role) {
            switch(role) {
                case 'admin': return 'Qu·∫£n Tr·ªã Vi√™n';
                case 'manager': return 'Qu·∫£n L√Ω';
                case 'employee': return 'Nh√¢n Vi√™n';
                default: return role;
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // X√≥a saved credentials khi logout
                localStorage.removeItem('saved_username');
                localStorage.removeItem('saved_password');
                localStorage.removeItem('remember_me');
                localStorage.removeItem('remember_expiry');
                
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout error:', error);
                
                // V·∫´n x√≥a credentials d√π c√≥ l·ªói
                localStorage.removeItem('saved_username');
                localStorage.removeItem('saved_password');
                localStorage.removeItem('remember_me');
                localStorage.removeItem('remember_expiry');
                
                window.location.href = '/login.html';
            }
        }

        // Set ng√†y m·∫∑c ƒë·ªãnh (h√¥m nay)
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('start_date').value = today;
            document.getElementById('end_date').value = today;
            document.getElementById('transaction_date').value = today;
            
            // Set default cho history filters - m·ªü r·ªông th√†nh 30 ng√†y
            document.getElementById('history_start_date').value = thirtyDaysAgo;
            document.getElementById('history_end_date').value = today;
            
            // Initialize quick filter dates and set default to "yesterday"
            initializeQuickFilterDates();
            setQuickFilter('yesterday');
        }

        // Initialize quick filter date displays
        function initializeQuickFilterDates() {
            const today = new Date();
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            // Update date displays
            document.getElementById('today-date').textContent = today.toLocaleDateString('vi-VN');
            document.getElementById('yesterday-date').textContent = yesterday.toLocaleDateString('vi-VN');
            document.getElementById('week-date').textContent = weekAgo.toLocaleDateString('vi-VN') + ' - ' + today.toLocaleDateString('vi-VN');
            document.getElementById('month-date').textContent = 'Th√°ng ' + (today.getMonth() + 1);
        }

        // Set quick filter for dashboard
        function setQuickFilter(period) {
            const today = new Date();
            let startDate, endDate;
            
            switch(period) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'yesterday':
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    startDate = endDate = yesterday.toISOString().split('T')[0];
                    break;
                case 'week':
                    endDate = today.toISOString().split('T')[0];
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'month':
                    endDate = today.toISOString().split('T')[0];
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    break;
            }
            
            // Update form inputs
            document.getElementById('start_date').value = startDate;
            document.getElementById('end_date').value = endDate;
            
            // Update active button
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // Collapse advanced filters when using quick filter
            document.getElementById('advanced-filter-content').style.display = 'none';
            document.getElementById('toggle-icon').textContent = '‚ñº';
            
            // Load dashboard with new dates
            loadDashboard();
        }

        // Toggle advanced filters
        function toggleAdvancedFilters() {
            const content = document.getElementById('advanced-filter-content');
            const icon = document.getElementById('toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
                
                // Remove active state from quick filters when using advanced
                document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        // Hi·ªÉn th·ªã tab
        function showTab(tabName) {
            // ·∫®n t·∫•t c·∫£ tab content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.style.display = 'none');

            // B·ªè active class t·ª´ t·∫•t c·∫£ tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');

            // Load d·ªØ li·ªáu theo tab
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'history') {
                loadTransactions();
            }
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Load danh s√°ch chi nh√°nh
        async function loadBranches() {
            try {
                const response = await fetch(`${API_BASE}/api/branches`, {
                    credentials: 'include'
                });
                const branches = await response.json();
                
                const selects = ['form_branch_id', 'dashboard_branch_id', 'history_branch_id'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    const currentValue = select.value;
                    
                    // Clear v√† th√™m option m·∫∑c ƒë·ªãnh
                    if (selectId === 'form_branch_id') {
                        select.innerHTML = '<option value="">-- Ch·ªçn chi nh√°nh --</option>';
                    } else {
                        select.innerHTML = '<option value="">-- T·∫•t c·∫£ chi nh√°nh --</option>';
                    }
                    
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = branch.name;
                        select.appendChild(option);
                    });
                    
                    select.value = currentValue;
                });

                // Set up event listeners cho branch selectors
                const formBranchSelect = document.getElementById('form_branch_id');
                if (formBranchSelect) {
                    formBranchSelect.addEventListener('change', loadMachines);
                }

                const historyBranchSelect = document.getElementById('history_branch_id');
                if (historyBranchSelect) {
                    historyBranchSelect.addEventListener('change', loadMachines);
                }
                
            } catch (error) {
                console.error('L·ªói khi load chi nh√°nh:', error);
                showAlert('L·ªói khi t·∫£i danh s√°ch chi nh√°nh', 'error');
            }
        }

        // Global variables cho machine selector
        let allMachines = [];
        let selectedMachine = null;

        // Load danh s√°ch m√°y
        async function loadMachines() {
            try {
                // L·∫•y branch_id ƒë·ªÉ filter
                const formBranchId = document.getElementById('form_branch_id')?.value;
                const historyBranchId = document.getElementById('history_branch_id')?.value;
                
                let url = `${API_BASE}/api/machines`;
                const params = new URLSearchParams();
                
                // T√πy theo context m√† d√πng branch_id kh√°c nhau
                if (formBranchId) {
                    params.append('branch_id', formBranchId);
                } else if (historyBranchId) {
                    params.append('branch_id', historyBranchId);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const machines = await response.json();
                
                // Store machines globally cho search
                allMachines = machines;
                
                const selects = ['machine_id', 'filter_machine'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    const currentValue = select.value;
                    
                    // Clear v√† th√™m option m·∫∑c ƒë·ªãnh
                    select.innerHTML = selectId === 'machine_id' ? 
                        '<option value="">-- Ch·ªçn m√°y ch∆°i game --</option>' :
                        '<option value="">-- T·∫•t c·∫£ m√°y --</option>';
                    
                    machines.forEach(machine => {
                        const option = document.createElement('option');
                        option.value = machine.id;
                        option.textContent = `${machine.name} (${machine.location}) - ${machine.branch_name}`;
                        select.appendChild(option);
                    });
                    
                    select.value = currentValue;
                });

                // Initialize machine search cho form entry
                initMachineSearch();
                
            } catch (error) {
                console.error('L·ªói khi load m√°y:', error);
                showAlert('L·ªói khi t·∫£i danh s√°ch m√°y ch∆°i game', 'error');
            }
        }

        // Initialize machine search functionality
        function initMachineSearch() {
            const searchInput = document.getElementById('machine_search');
            const dropdown = document.getElementById('machine_dropdown');
            const hiddenSelect = document.getElementById('machine_id');
            const selectedDiv = document.getElementById('selected_machine');

            if (!searchInput || !dropdown) return;

            // Show dropdown khi focus v√†o search
            searchInput.addEventListener('focus', () => {
                showMachineDropdown();
            });

            // Search while typing
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                filterMachines(query);
            });

            // Hide dropdown khi click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.machine-selector')) {
                    dropdown.style.display = 'none';
                }
            });

            // Prevent form submission on Enter in search
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Select first visible option
                    const firstOption = dropdown.querySelector('.machine-option:not([style*="display: none"])');
                    if (firstOption) {
                        selectMachine(JSON.parse(firstOption.dataset.machine));
                    }
                }
            });
        }

        function showMachineDropdown() {
            const dropdown = document.getElementById('machine_dropdown');
            if (!dropdown || allMachines.length === 0) return;

            filterMachines(''); // Show all machines initially
            dropdown.style.display = 'block';
        }

        function filterMachines(query) {
            const dropdown = document.getElementById('machine_dropdown');
            if (!dropdown) return;

            const filteredMachines = allMachines.filter(machine => 
                machine.name.toLowerCase().includes(query) ||
                machine.location.toLowerCase().includes(query) ||
                machine.branch_name.toLowerCase().includes(query)
            );

            dropdown.innerHTML = '';

            if (filteredMachines.length === 0) {
                dropdown.innerHTML = '<div class="machine-option" style="color: #666;">Kh√¥ng t√¨m th·∫•y m√°y n√†o</div>';
                return;
            }

            filteredMachines.forEach(machine => {
                const option = document.createElement('div');
                option.className = 'machine-option';
                option.dataset.machine = JSON.stringify(machine);
                option.innerHTML = `
                    <div class="machine-name">${machine.name}</div>
                    <div class="machine-details">üìç ${machine.location} | üè¢ ${machine.branch_name}</div>
                `;
                
                option.addEventListener('click', () => {
                    selectMachine(machine);
                });

                dropdown.appendChild(option);
            });
        }

        function selectMachine(machine) {
            selectedMachine = machine;
            
            const searchInput = document.getElementById('machine_search');
            const dropdown = document.getElementById('machine_dropdown');
            const hiddenSelect = document.getElementById('machine_id');
            const selectedDiv = document.getElementById('selected_machine');

            // Update search input
            searchInput.value = `${machine.name} - ${machine.location}`;
            
            // Update hidden select for form submission
            hiddenSelect.value = machine.id;
            
            // Show selected machine info
            selectedDiv.innerHTML = `
                üéÆ <strong>${machine.name}</strong><br>
                üìç ${machine.location} | üè¢ ${machine.branch_name}
                <button type="button" class="clear-selection" onclick="clearMachineSelection()">‚úï</button>
            `;
            selectedDiv.style.display = 'block';
            
            // Hide dropdown
            dropdown.style.display = 'none';

            // Trigger change event for validation
            hiddenSelect.dispatchEvent(new Event('change'));
        }

        function clearMachineSelection() {
            selectedMachine = null;
            
            const searchInput = document.getElementById('machine_search');
            const hiddenSelect = document.getElementById('machine_id');
            const selectedDiv = document.getElementById('selected_machine');

            searchInput.value = '';
            hiddenSelect.value = '';
            selectedDiv.style.display = 'none';

            // Focus back to search
            searchInput.focus();
        }

        // X·ª≠ l√Ω form th√™m giao d·ªãch
        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validation ng√†y
            const selectedDate = document.getElementById('transaction_date').value;
            const today = new Date().toISOString().split('T')[0];
            
            if (selectedDate > today) {
                showAlert('‚ùå Kh√¥ng th·ªÉ nh·∫≠p giao d·ªãch cho ng√†y t∆∞∆°ng lai! Ch·ªâ ƒë∆∞·ª£c nh·∫≠p t·ª´ h√¥m nay tr·ªü v·ªÅ tr∆∞·ªõc.', 'error');
                return;
            }
            
            // C·∫£nh b√°o n·∫øu nh·∫≠p mu·ªôn (ng√†y qu√° kh·ª©)
            if (selectedDate < today) {
                const confirmLate = confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n ƒëang nh·∫≠p giao d·ªãch cho ng√†y ${selectedDate} (qu√° kh·ª©).\n\nƒê√¢y s·∫Ω ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† "NH·∫¨P MU·ªòN".\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?`);
                if (!confirmLate) {
                    return;
                }
            }
            
            const formData = {
                machine_id: parseInt(document.getElementById('machine_id').value),
                coins_in: parseInt(document.getElementById('coins_in').value) || 0,
                coins_out: parseInt(document.getElementById('coins_out').value) || 0,
                note: document.getElementById('note').value,
                transaction_date: selectedDate
            };

            try {
                const response = await fetch(`${API_BASE}/api/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ${result.message}. Doanh thu: ${result.data.revenue} xu`);
                    document.getElementById('transactionForm').reset();
                    loadDashboard(); // Refresh dashboard
                    
                    // Refresh history n·∫øu user ƒëang ·ªü tab history
                    const currentTab = document.querySelector('.tab.active');
                    if (currentTab && currentTab.textContent.includes('L·ªãch S·ª≠')) {
                        loadTransactions();
                    }
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('L·ªói khi th√™m giao d·ªãch:', error);
                showAlert('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        });

        // Load dashboard
        async function loadDashboard() {
            try {
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                const branchId = document.getElementById('dashboard_branch_id')?.value;
                
                // Debug dashboard params
                console.log('üîç loadDashboard DEBUG:');
                console.log('Dashboard params:', { startDate, endDate, branchId });
                console.log('Current User:', currentUser);
                console.log('üîç Period being queried:', startDate === endDate ? `Single day: ${startDate}` : `Range: ${startDate} to ${endDate}`);
                
                const url = new URL(`${window.location.origin}/api/dashboard`);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                if (branchId) url.searchParams.append('branch_id', branchId);

                console.log('üåê Dashboard API URL:', url.toString());

                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                console.log('üì¶ Dashboard API Response:', data);

                // Hi·ªÉn th·ªã stats t·ªïng quan
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h3>${data.total_revenue || 0}</h3>
                        <p>T·ªïng Doanh Thu (xu)</p>
                    </div>
                    <div class="stat-card">
                        <h3>${data.total_coins_in || 0}</h3>
                        <p>T·ªïng Xu V√†o</p>
                    </div>
                    <div class="stat-card">
                        <h3>${data.total_coins_out || 0}</h3>
                        <p>T·ªïng Xu Ra</p>
                    </div>
                    <div class="stat-card">
                        <h3>${data.total_machines || 0}</h3>
                        <p>S·ªë M√°y Ho·∫°t ƒê·ªông</p>
                    </div>
                `;

                // Hi·ªÉn th·ªã doanh thu theo chi nh√°nh (n·∫øu c√≥)
                const machineRevenue = document.getElementById('machine-revenue');
                let revenueHtml = '';
                
                if (data.branches && data.branches.length > 0) {
                    revenueHtml += '<h3>üè¢ Doanh Thu Theo Chi Nh√°nh</h3>';
                    data.branches.forEach(branch => {
                        revenueHtml += `
                            <div class="machine-item">
                                <div>
                                    <strong>${branch.branch_name}</strong><br>
                                    <small>üìç ${branch.address || 'N/A'} | üë®‚Äçüíº ${branch.manager_name || 'N/A'}</small><br>
                                    <small>üéÆ ${branch.machine_count || 0} m√°y</small>
                                </div>
                                <div style="text-align: right;">
                                    <strong style="color: #28a745;">${branch.total_revenue || 0} xu</strong><br>
                                    <small>V√†o: ${branch.total_coins_in || 0} | Ra: ${branch.total_coins_out || 0}</small>
                                </div>
                            </div>
                        `;
                    });
                }

                // Hi·ªÉn th·ªã doanh thu theo m√°y - LU√îN hi·ªÉn th·ªã section n√†y
                revenueHtml += '<h3 style="margin-top: 20px;">üéÆ Doanh Thu Theo M√°y</h3>';
                
                if (data.machines && data.machines.length > 0) {
                    console.log('üéÆ Machine data from API:', data.machines);
                    
                    // Store dashboard machines ƒë·ªÉ so s√°nh v·ªõi recent transactions
                    window.lastDashboardMachines = data.machines;
                    
                    // Sort machines theo doanh thu gi·∫£m d·∫ßn
                    const sortedMachines = data.machines.sort((a, b) => (b.total_revenue || 0) - (a.total_revenue || 0));
                    
                    sortedMachines.forEach((machine, index) => {
                        console.log(`üéÆ Machine ${index}:`, machine);
                        const machineName = machine.machine_name || machine.name || 'M√°y kh√¥ng x√°c ƒë·ªãnh';
                        const location = machine.location || 'V·ªã tr√≠ kh√¥ng x√°c ƒë·ªãnh';
                        const branchName = machine.branch_name || 'Chi nh√°nh kh√¥ng x√°c ƒë·ªãnh';
                        const revenue = machine.total_revenue || 0;
                        const coinsIn = machine.total_coins_in || 0;
                        const coinsOut = machine.total_coins_out || 0;
                        const transactionCount = machine.transaction_count || 0;
                        
                        // T√≠nh t·ª∑ l·ªá th·∫Øng/thua cho m√°y
                        const winRate = coinsIn > 0 ? ((revenue / coinsIn) * 100).toFixed(1) : '0.0';
                        const revenueClass = revenue > 0 ? '#28a745' : revenue < 0 ? '#dc3545' : '#6c757d';
                        const revenueIcon = revenue > 0 ? 'üìà' : revenue < 0 ? 'üìâ' : '‚ûñ';
                        
                        revenueHtml += `
                            <div class="machine-item" style="margin-bottom: 12px;">
                                <div>
                                    <strong>${machineName}</strong>
                                    <span style="margin-left: 8px; background: ${revenue > 0 ? '#d4edda' : revenue < 0 ? '#f8d7da' : '#e9ecef'}; 
                                                 color: ${revenue > 0 ? '#155724' : revenue < 0 ? '#721c24' : '#495057'}; 
                                                 padding: 2px 6px; border-radius: 12px; font-size: 11px;">
                                        ${revenueIcon} ${winRate}%
                                    </span><br>
                                    <small style="color: #666;">üìç ${location} | üè¢ ${branchName}</small><br>
                                    <small style="color: #888;">üìä ${transactionCount} giao d·ªãch</small>
                                </div>
                                <div style="text-align: right;">
                                    <strong style="color: ${revenueClass}; font-size: 1.1em;">
                                        ${revenue > 0 ? '+' : ''}${revenue.toLocaleString()} xu
                                    </strong><br>
                                    <small style="color: #666;">
                                        V√†o: ${coinsIn.toLocaleString()} | Ra: ${coinsOut.toLocaleString()}
                                    </small>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // Fallback: Hi·ªÉn th·ªã danh s√°ch m√°y hi·ªán c√≥ v·ªõi doanh thu 0
                    revenueHtml += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #dee2e6;">
                            <p style="color: #6c757d; margin: 0; text-align: center;">
                                üìä Ch∆∞a c√≥ giao d·ªãch n√†o trong kho·∫£ng th·ªùi gian n√†y
                            </p>
                        </div>
                        <div style="margin-top: 15px;">
                            <h4 style="color: #666; font-size: 0.95em; margin-bottom: 10px;">üìã Danh s√°ch m√°y hi·ªán c√≥:</h4>
                            <div id="available-machines-list">
                                <div style="color: #666; font-style: italic;">ƒêang t·∫£i danh s√°ch m√°y...</div>
                            </div>
                        </div>
                    `;
                    
                    // Load danh s√°ch m√°y ƒë·ªÉ hi·ªÉn th·ªã fallback
                    loadAvailableMachinesForDashboard(branchId);
                }
                
                if (!revenueHtml) {
                    const startDate = document.getElementById('start_date').value;
                    const endDate = document.getElementById('end_date').value;
                    const activeQuickFilter = document.querySelector('.quick-filter-btn.active');
                    let periodName = `${startDate} ƒë·∫øn ${endDate}`;
                    
                    if (activeQuickFilter) {
                        const period = activeQuickFilter.dataset.period;
                        switch(period) {
                            case 'today': periodName = 'h√¥m nay'; break;
                            case 'yesterday': periodName = 'h√¥m qua'; break;
                            case 'week': periodName = '7 ng√†y qua'; break;
                            case 'month': periodName = 'th√°ng n√†y'; break;
                        }
                    }
                    
                    revenueHtml = `
                        <div style="text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #dee2e6;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üìä</div>
                            <h3 style="color: #6c757d; margin-bottom: 10px;">Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
                            <p style="color: #6c757d; margin-bottom: 20px;">Kh√¥ng c√≥ giao d·ªãch n√†o trong kho·∫£ng th·ªùi gian <strong>${periodName}</strong></p>
                            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="showTab('entry')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    ‚ûï Th√™m Giao D·ªãch
                                </button>
                                <button onclick="setQuickFilter('week')" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üìä Xem 7 Ng√†y Qua
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                machineRevenue.innerHTML = revenueHtml;

                // Load th√¥ng tin giao d·ªãch g·∫ßn ƒë√¢y cho manager/admin
                if (currentUser && (currentUser.role === 'manager' || currentUser.role === 'admin')) {
                    await loadRecentTransactionsForDashboard(startDate, endDate, branchId);
                }

            } catch (error) {
                console.error('L·ªói khi load dashboard:', error);
                showAlert('L·ªói khi t·∫£i d·ªØ li·ªáu dashboard', 'error');
            }
        }

        // Load danh s√°ch m√°y ƒë·ªÉ hi·ªÉn th·ªã khi kh√¥ng c√≥ data
        async function loadAvailableMachinesForDashboard(branchId) {
            try {
                let url = `${API_BASE}/api/machines`;
                if (branchId) {
                    url += `?branch_id=${branchId}`;
                }
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const machines = await response.json();
                
                const machinesList = document.getElementById('available-machines-list');
                if (machinesList) {
                    if (machines && machines.length > 0) {
                        let machinesHtml = '';
                        machines.forEach(machine => {
                            machinesHtml += `
                                <div class="machine-item" style="margin-bottom: 8px; opacity: 0.7;">
                                    <div>
                                        <strong>${machine.name}</strong><br>
                                        <small style="color: #666;">üìç ${machine.location} | üè¢ ${machine.branch_name}</small>
                                    </div>
                                    <div style="text-align: right; color: #6c757d;">
                                        <span style="font-size: 0.9em;">Ch∆∞a c√≥ giao d·ªãch</span>
                                    </div>
                                </div>
                            `;
                        });
                        machinesList.innerHTML = machinesHtml;
                    } else {
                        machinesList.innerHTML = '<div style="color: #999; font-style: italic;">Kh√¥ng c√≥ m√°y n√†o ƒë∆∞·ª£c t√¨m th·∫•y</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading available machines:', error);
                const machinesList = document.getElementById('available-machines-list');
                if (machinesList) {
                    machinesList.innerHTML = '<div style="color: #999;">Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√°y</div>';
                }
            }
        }

        // Load giao d·ªãch g·∫ßn ƒë√¢y cho Dashboard (Manager/Admin)
        async function loadRecentTransactionsForDashboard(startDate, endDate, branchId) {
            try {
                console.log('üîç loadRecentTransactionsForDashboard DEBUG:');
                console.log('Recent transactions params:', { startDate, endDate, branchId });
                
                const url = new URL(`${window.location.origin}/api/transactions`);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                if (branchId) url.searchParams.append('branch_id', branchId);
                url.searchParams.append('limit', '10'); // Ch·ªâ l·∫•y 10 giao d·ªãch g·∫ßn nh·∫•t
                url.searchParams.append('sort_by', 'date_desc');
                
                console.log('üåê Recent Transactions API URL:', url.toString());

                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                console.log('üì¶ Recent Transactions API Response:', data);
                
                const transactions = data.transactions || data;
                console.log('üì¶ Recent Transactions Array:', transactions);
                console.log('üì¶ Recent Transactions Count:', transactions?.length);
                
                // So s√°nh machine data gi·ªØa dashboard v√† recent transactions
                console.log('üîç COMPARISON ANALYSIS:');
                if (window.lastDashboardMachines && transactions?.length > 0) {
                    const dashboardMachineIds = window.lastDashboardMachines.map(m => m.machine_id || m.id);
                    const recentTransactionMachineIds = [...new Set(transactions.map(t => t.machine_id))];
                    
                    console.log('üéÆ Dashboard machine IDs:', dashboardMachineIds);
                    console.log('üìã Recent transaction machine IDs:', recentTransactionMachineIds);
                    
                    const missingFromDashboard = recentTransactionMachineIds.filter(id => !dashboardMachineIds.includes(id));
                    const missingFromRecent = dashboardMachineIds.filter(id => !recentTransactionMachineIds.includes(id));
                    
                    if (missingFromDashboard.length > 0) {
                        console.log('‚ö†Ô∏è Machines in recent transactions but NOT in dashboard revenue:', missingFromDashboard);
                    }
                    if (missingFromRecent.length > 0) {
                        console.log('‚ö†Ô∏è Machines in dashboard revenue but NOT in recent transactions:', missingFromRecent);
                    }
                }
                
                // T·∫°o section cho giao d·ªãch g·∫ßn ƒë√¢y
                const machineRevenue = document.getElementById('machine-revenue');
                
                if (transactions && transactions.length > 0) {
                    // Th·ªëng k√™ nh·∫≠p li·ªáu
                    let lateCount = 0;
                    let onTimeCount = 0;
                    const lateUsers = {};
                    
                                         transactions.forEach(transaction => {
                         // Nh·∫≠p mu·ªôn = ng√†y nh·∫≠p > ng√†y giao d·ªãch
                         const createdDateStr = new Date(transaction.created_at).toISOString().split('T')[0];
                         const transactionDateStr = transaction.transaction_date;
                         const isLate = createdDateStr > transactionDateStr;
                         if (isLate) {
                             lateCount++;
                             if (transaction.user_name) {
                                 lateUsers[transaction.user_name] = (lateUsers[transaction.user_name] || 0) + 1;
                             }
                         } else {
                             onTimeCount++;
                         }
                     });
                    
                    const latePercentage = transactions.length > 0 ? Math.round((lateCount / transactions.length) * 100) : 0;
                    
                    // Th√™m th·ªëng k√™ nh·∫≠p li·ªáu v√†o dashboard
                    const entryStatsHtml = `
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 20px;">
                            <h3>‚è∞ Th·ªëng K√™ Nh·∫≠p Li·ªáu (${transactions.length} giao d·ªãch g·∫ßn nh·∫•t)</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
                                <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #c3e6cb;">
                                    <div style="font-size: 1.8em; font-weight: bold; color: #155724;">${onTimeCount}</div>
                                    <div style="color: #155724; font-weight: 600;">Nh·∫≠p ƒë√∫ng gi·ªù ‚úÖ</div>
                                </div>
                                <div style="background: ${lateCount > 0 ? '#f8d7da' : '#e2e3e5'}; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid ${lateCount > 0 ? '#f5c6cb' : '#d6d8db'};">
                                    <div style="font-size: 1.8em; font-weight: bold; color: ${lateCount > 0 ? '#721c24' : '#6c757d'};">${lateCount}</div>
                                    <div style="color: ${lateCount > 0 ? '#721c24' : '#6c757d'}; font-weight: 600;">Nh·∫≠p mu·ªôn ‚ö†Ô∏è</div>
                                </div>
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #b3d9ff;">
                                    <div style="font-size: 1.8em; font-weight: bold; color: #0d47a1;">${latePercentage}%</div>
                                    <div style="color: #0d47a1; font-weight: 600;">T·ª∑ l·ªá nh·∫≠p mu·ªôn</div>
                                </div>
                            </div>
                            ${Object.keys(lateUsers).length > 0 ? `
                                <div style="margin-top: 15px;">
                                    <strong>üë• Nh√¢n vi√™n nh·∫≠p mu·ªôn:</strong><br>
                                    <div style="margin-top: 8px;">
                                        ${Object.entries(lateUsers).map(([user, count]) => 
                                            `<span style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; margin: 2px; display: inline-block; border: 1px solid #ffeaa7;">${user}: ${count} l·∫ßn</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Th√™m giao d·ªãch g·∫ßn ƒë√¢y v·ªõi chi ti·∫øt ng√†y nh·∫≠p
                    const recentTransactionsHtml = `
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 20px;">
                            <h3>üìã Giao D·ªãch G·∫ßn ƒê√¢y (Chi Ti·∫øt Ng√†y Nh·∫≠p)</h3>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${transactions.slice(0, 8).map(transaction => {
                                    const createdTime = new Date(transaction.created_at);
                                    const inputTime = createdTime.toLocaleTimeString('vi-VN', {
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit'
                                    });
                                    const inputDate = createdTime.toLocaleDateString('vi-VN');
                                    const transactionDate = new Date(transaction.transaction_date).toLocaleDateString('vi-VN');
                                    // Nh·∫≠p mu·ªôn = ng√†y nh·∫≠p > ng√†y giao d·ªãch
                                    const createdDateStr = new Date(transaction.created_at).toISOString().split('T')[0];
                                    const transactionDateStr = transaction.transaction_date;
                                    const isLate = createdDateStr > transactionDateStr;
                                    
                                    return `
                                        <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${transaction.revenue >= 0 ? '#28a745' : '#dc3545'};">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                                <div>
                                                    <strong>${transaction.machine_name}</strong><br>
                                                    <small style="color: #666;">üìç ${transaction.location} | üè¢ ${transaction.branch_name}</small><br>
                                                    ${transaction.user_name ? `<small style="color: #666;">üë§ ${transaction.user_name}</small>` : ''}
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-size: 1.1em; font-weight: bold; color: ${transaction.revenue >= 0 ? '#28a745' : '#dc3545'};">
                                                        ${transaction.revenue > 0 ? '+' : ''}${transaction.revenue} xu
                                                    </div>
                                                    <small style="color: #666;">V√†o: ${transaction.coins_in} | Ra: ${transaction.coins_out}</small>
                                                </div>
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                                                <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid #2196f3;">
                                                    üìÖ <strong>Ng√†y GD:</strong> ${transactionDate}
                                                </span>
                                                <span style="background: ${isLate ? '#fff3cd' : '#d4edda'}; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid ${isLate ? '#ffeaa7' : '#c3e6cb'}; ${isLate ? 'color: #ff6b35; font-weight: bold;' : ''}">
                                                    ‚è∞ <strong>Nh·∫≠p:</strong> ${inputDate} ${inputTime} ${isLate ? '‚ö†Ô∏è' : '‚úÖ'}
                                                </span>
                                                ${transaction.note ? `<span style="background: #e7f3ff; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid #b3d9ff;">üìù ${transaction.note}</span>` : ''}
                                            </div>
                                                                                         ${isLate ? `<div style="color: #ff6b35; font-size: 0.85em; margin-top: 8px; background: #fff3cd; padding: 6px; border-radius: 4px; border-left: 3px solid #ff6b35;">‚ö†Ô∏è <strong>Nh·∫≠p mu·ªôn:</strong> Giao d·ªãch ng√†y ${transactionDate} ƒë∆∞·ª£c nh·∫≠p v√†o ng√†y ${inputDate}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="showTab('history')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">üìã Xem T·∫•t C·∫£ L·ªãch S·ª≠</button>
                            </div>
                        </div>
                    `;
                    
                    // Th√™m v√†o cu·ªëi machine revenue
                    machineRevenue.innerHTML += entryStatsHtml + recentTransactionsHtml;
                }

            } catch (error) {
                console.error('L·ªói khi load giao d·ªãch g·∫ßn ƒë√¢y:', error);
            }
        }

        // Load danh s√°ch users cho manager
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/api/users`, {
                    credentials: 'include'
                });
                const users = await response.json();
                
                const select = document.getElementById('history_user_id');
                if (select) {
                    select.innerHTML = '<option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.full_name} (${user.username})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('L·ªói khi load users:', error);
            }
        }

        // Clear history filters
        function clearHistoryFilters() {
            const today = new Date().toISOString().split('T')[0];
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('filter_machine').value = '';
            document.getElementById('history_user_id').value = '';
            document.getElementById('history_start_date').value = sevenDaysAgo;
            document.getElementById('history_end_date').value = today;
            document.getElementById('sort_by').value = 'date_desc';
            
            if (document.getElementById('history_branch_id')) {
                document.getElementById('history_branch_id').value = '';
            }
            
            // Reset late entry filter
            if (document.getElementById('filter_late_entry')) {
                document.getElementById('filter_late_entry').value = '';
            }
            
            // Reset user selector n·∫øu c√≥
            if (document.getElementById('history_user_id')) {
                document.getElementById('history_user_id').value = '';
            }
            
            loadTransactions();
        }

        // Load l·ªãch s·ª≠ giao d·ªãch v·ªõi filter n√¢ng cao
        async function loadTransactions() {
            try {
                const machineId = document.getElementById('filter_machine').value;
                const branchId = document.getElementById('history_branch_id')?.value;
                const userId = document.getElementById('history_user_id')?.value;
                const startDate = document.getElementById('history_start_date').value;
                const endDate = document.getElementById('history_end_date').value;
                const sortBy = document.getElementById('sort_by').value;
                const lateEntryFilter = document.getElementById('filter_late_entry')?.value;
                
                // Debug current user and filter params
                console.log('üîç loadTransactions DEBUG:');
                console.log('Current User:', currentUser);
                console.log('Filter params:', { machineId, branchId, userId, startDate, endDate, sortBy });
                
                const url = new URL(`${window.location.origin}/api/transactions`);
                if (machineId) url.searchParams.append('machine_id', machineId);
                if (branchId) url.searchParams.append('branch_id', branchId);
                if (userId) url.searchParams.append('user_id', userId);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                if (sortBy) url.searchParams.append('sort_by', sortBy);
                url.searchParams.append('limit', '50');

                console.log('üåê API URL:', url.toString());

                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                console.log('üì¶ API Response:', data);
                console.log('üì¶ Data type:', typeof data);
                console.log('üì¶ Is Array:', Array.isArray(data));
                
                // Hi·ªÉn th·ªã summary
                displayHistorySummary(data.summary || {});
                
                let transactions = data.transactions || data;
                console.log('üì¶ Transactions:', transactions);
                console.log('üì¶ Transactions length:', transactions?.length);
                
                // Th·ªëng k√™ late entry cho manager/admin
                if (currentUser && (currentUser.role === 'manager' || currentUser.role === 'admin')) {
                    displayLateEntryStats(transactions);
                }
                
                // Filter theo late entry n·∫øu c·∫ßn
                if (lateEntryFilter) {
                    transactions = transactions.filter(transaction => {
                        // Nh·∫≠p mu·ªôn = ng√†y nh·∫≠p d·ªØ li·ªáu > ng√†y giao d·ªãch
                        const createdDateStr = transaction.created_at.split('T')[0];
                        const transactionDateStr = transaction.transaction_date;
                        const isLate = createdDateStr > transactionDateStr;
                        if (lateEntryFilter === 'late') return isLate;
                        if (lateEntryFilter === 'ontime') return !isLate;
                        return true;
                    });
                }
                
                const historyContainer = document.getElementById('transaction-history');
                
                if (transactions.length > 0) {
                    // Group transactions by date
                    const groupedTransactions = groupTransactionsByDate(transactions);
                    let historyHtml = '';
                    
                    Object.keys(groupedTransactions).forEach(date => {
                        const dayTransactions = groupedTransactions[date];
                        const dayTotal = dayTransactions.reduce((sum, t) => sum + t.revenue, 0);
                        
                        historyHtml += `
                            <div class="date-group">
                                <h3>üìÖ ${formatDateVN(date)} - T·ªïng: <span style="color: ${dayTotal >= 0 ? '#28a745' : '#dc3545'};">${dayTotal} xu</span></h3>
                            </div>
                        `;
                        
                        dayTransactions.forEach(transaction => {
                            // Debug log ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
                            console.log('üîç Processing transaction:', transaction);
                            
                            const createdTime = new Date(transaction.created_at);
                            const inputTime = createdTime.toLocaleTimeString('vi-VN', {
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            const inputDate = createdTime.toLocaleDateString('vi-VN');
                            const transactionDate = new Date(transaction.transaction_date).toLocaleDateString('vi-VN');
                            
                            // Ki·ªÉm tra xem c√≥ nh·∫≠p mu·ªôn kh√¥ng
                            // Nh·∫≠p mu·ªôn = ng√†y nh·∫≠p d·ªØ li·ªáu > ng√†y giao d·ªãch
                            // V√≠ d·ª•: GD ng√†y 23/6 nh∆∞ng nh·∫≠p v√†o ng√†y 24/6 = nh·∫≠p mu·ªôn
                            const transactionDateStr = transaction.transaction_date; // yyyy-mm-dd
                            const createdDateStr = transaction.created_at.split('T')[0]; // yyyy-mm-dd t·ª´ timestamp
                            const isLateEntry = createdDateStr > transactionDateStr;
                            
                            console.log(`üìÖ Transaction Date: ${transactionDateStr}`);
                            console.log(`‚è∞ Created At: ${transaction.created_at}`);
                            console.log(`‚è∞ Created Date: ${createdDateStr}`);
                            console.log(`‚è∞ Input Date: ${inputDate}`);
                            console.log(`üîç Is Late Entry: ${isLateEntry} (created: ${createdDateStr} > transaction: ${transactionDateStr})`);
                            
                            historyHtml += `
                                <div class="transaction-item">
                                    <div class="transaction-header">
                                        <div class="transaction-info">
                                            <h4>${transaction.machine_name}</h4>
                                            <div class="meta">
                                                üìç ${transaction.location} | üè¢ ${transaction.branch_name}<br>
                                                ${transaction.user_name ? `üë§ ${transaction.user_name}` : ''}
                                            </div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="revenue" style="color: ${transaction.revenue >= 0 ? '#28a745' : '#dc3545'};">
                                                ${transaction.revenue > 0 ? '+' : ''}${transaction.revenue} xu
                                            </div>
                                            <div class="coins">
                                                V√†o: ${transaction.coins_in} | Ra: ${transaction.coins_out}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="transaction-footer">
                                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 5px 0;">
                                            <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; border: 1px solid #2196f3;">
                                                üìÖ <strong>Ng√†y GD:</strong> ${transactionDate}
                                            </span>
                                            <span style="background: ${isLateEntry ? '#fff3cd' : '#d4edda'}; padding: 4px 8px; border-radius: 4px; border: 1px solid ${isLateEntry ? '#ffeaa7' : '#c3e6cb'}; ${isLateEntry ? 'color: #ff6b35; font-weight: bold;' : ''}">
                                                ‚è∞ <strong>Nh·∫≠p l√∫c:</strong> ${inputDate} ${inputTime}
                                                ${isLateEntry ? ' ‚ö†Ô∏è' : ' ‚úÖ'}
                                            </span>
                                            ${transaction.note ? `<span style="background: #e7f3ff; padding: 4px 8px; border-radius: 4px; border: 1px solid #b3d9ff;">üìù ${transaction.note}</span>` : ''}
                                        </div>
                                        ${isLateEntry ? `<div style="color: #ff6b35; font-size: 0.9em; margin-top: 5px; background: #fff3cd; padding: 8px; border-radius: 4px; border-left: 4px solid #ff6b35;">‚ö†Ô∏è <strong>Nh·∫≠p mu·ªôn:</strong> Giao d·ªãch ng√†y ${transactionDate} ƒë∆∞·ª£c nh·∫≠p v√†o ng√†y ${inputDate}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    });
                    
                    historyContainer.innerHTML = historyHtml;
                } else {
                    historyContainer.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y giao d·ªãch n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</p>';
                }

            } catch (error) {
                console.error('L·ªói khi load l·ªãch s·ª≠:', error);
                showAlert('L·ªói khi t·∫£i l·ªãch s·ª≠ giao d·ªãch', 'error');
            }
        }

        // Group transactions by date
        function groupTransactionsByDate(transactions) {
            const grouped = {};
            transactions.forEach(transaction => {
                const date = transaction.transaction_date || transaction.created_at.split('T')[0];
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(transaction);
            });
            return grouped;
        }

        // Format date in Vietnamese
        function formatDateVN(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            if (dateStr === today.toISOString().split('T')[0]) {
                return 'H√¥m nay (' + date.toLocaleDateString('vi-VN') + ')';
            } else if (dateStr === yesterday.toISOString().split('T')[0]) {
                return 'H√¥m qua (' + date.toLocaleDateString('vi-VN') + ')';
            } else {
                return date.toLocaleDateString('vi-VN');
            }
        }

        // Hi·ªÉn th·ªã th·ªëng k√™ late entry cho manager/admin
        function displayLateEntryStats(transactions) {
            if (!transactions || transactions.length === 0) return;
            
            let lateCount = 0;
            let onTimeCount = 0;
            const lateUsers = {};
            
            transactions.forEach(transaction => {
                // Nh·∫≠p mu·ªôn = ng√†y nh·∫≠p d·ªØ li·ªáu > ng√†y giao d·ªãch
                const createdDateStr = transaction.created_at.split('T')[0];
                const transactionDateStr = transaction.transaction_date;
                const isLate = createdDateStr > transactionDateStr;
                if (isLate) {
                    lateCount++;
                    if (transaction.user_name) {
                        lateUsers[transaction.user_name] = (lateUsers[transaction.user_name] || 0) + 1;
                    }
                } else {
                    onTimeCount++;
                }
            });
            
            const latePercentage = transactions.length > 0 ? Math.round((lateCount / transactions.length) * 100) : 0;
            
            // T·∫°o late entry summary
            const existingSummary = document.getElementById('history-summary');
            const lateEntryHtml = `
                <div style="background: ${lateCount > 0 ? '#fff3cd' : '#d4edda'}; border: 1px solid ${lateCount > 0 ? '#ffeaa7' : '#c3e6cb'}; border-radius: 8px; padding: 15px; margin: 15px 0;">
                    <h3>‚è∞ Th·ªëng K√™ Nh·∫≠p Li·ªáu</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 10px 0;">
                        <div style="text-align: center; background: #d4edda; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #155724;">${onTimeCount}</div>
                            <div style="color: #155724;">Nh·∫≠p ƒë√∫ng gi·ªù ‚úÖ</div>
                        </div>
                        <div style="text-align: center; background: ${lateCount > 0 ? '#f8d7da' : '#e2e3e5'}; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: ${lateCount > 0 ? '#721c24' : '#6c757d'};">${lateCount}</div>
                            <div style="color: ${lateCount > 0 ? '#721c24' : '#6c757d'};">Nh·∫≠p mu·ªôn ‚ö†Ô∏è</div>
                        </div>
                        <div style="text-align: center; background: #e3f2fd; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #0d47a1;">${latePercentage}%</div>
                            <div style="color: #0d47a1;">T·ª∑ l·ªá nh·∫≠p mu·ªôn</div>
                        </div>
                    </div>
                    ${Object.keys(lateUsers).length > 0 ? `
                        <div style="margin-top: 10px;">
                            <strong>üë• Nh√¢n vi√™n nh·∫≠p mu·ªôn:</strong><br>
                            ${Object.entries(lateUsers).map(([user, count]) => 
                                `<span style="background: #fff3cd; padding: 2px 6px; border-radius: 4px; margin: 2px; display: inline-block;">${user}: ${count} l·∫ßn</span>`
                            ).join('')}
                        </div>
                    ` : ''}
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        üí° <strong>Tip:</strong> S·ª≠ d·ª•ng filter "L·ªçc Nh·∫≠p Mu·ªôn" ƒë·ªÉ xem chi ti·∫øt c√°c giao d·ªãch nh·∫≠p mu·ªôn.
                    </div>
                </div>
            `;
            
            // Remove existing late entry stats n·∫øu c√≥
            const existingLateStats = document.querySelector('.late-entry-stats');
            if (existingLateStats) {
                existingLateStats.remove();
            }
            
            // Th√™m v√†o sau existing summary
            if (existingSummary) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = lateEntryHtml.replace('<div style=', '<div class="late-entry-stats" style=');
                existingSummary.parentNode.insertBefore(tempDiv.firstElementChild, existingSummary.nextSibling);
            }
        }

        // Display history summary
        function displayHistorySummary(summary) {
            const summaryContainer = document.getElementById('history-summary');
            if (!summary || Object.keys(summary).length === 0) {
                summaryContainer.style.display = 'none';
                return;
            }
            
            summaryContainer.style.display = 'block';
            summaryContainer.innerHTML = `
                <h3>üìä T·ªïng Quan K·∫øt Qu·∫£ T√¨m Ki·∫øm</h3>
                <div class="summary-stats">
                    <div class="summary-card">
                        <h4>${summary.total_transactions || 0}</h4>
                        <p>T·ªïng Giao D·ªãch</p>
                    </div>
                    <div class="summary-card">
                        <h4>${summary.total_revenue || 0}</h4>
                        <p>T·ªïng Doanh Thu (xu)</p>
                    </div>
                    <div class="summary-card">
                        <h4>${summary.total_coins_in || 0}</h4>
                        <p>T·ªïng Xu V√†o</p>
                    </div>
                    <div class="summary-card">
                        <h4>${summary.total_coins_out || 0}</h4>
                        <p>T·ªïng Xu Ra</p>
                    </div>
                </div>
            `;
        }

        // Debug function cho manager/admin
        function debugTransactions() {
            console.log('üîß Debug Mode - Current User:', currentUser);
            console.log('üîß Checking UI elements...');
            
            const elements = [
                'history_user_selector',
                'late_entry_filter', 
                'filter_late_entry',
                'history_user_id'
            ];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                console.log(`üîß Element ${id}:`, el ? 'EXISTS' : 'NOT FOUND', el?.style.display || 'default');
            });
            
            // Test load transactions
            console.log('üîß Testing loadTransactions...');
            loadTransactions();
        }

        // T·∫°o test data cho manager
        async function createTestData() {
            if (!confirm('T·∫°o d·ªØ li·ªáu test? (S·∫Ω th√™m giao d·ªãch cho ng√†y h√¥m qua - ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† NH·∫¨P MU·ªòN)')) return;
            
            try {
                // T·∫°o giao d·ªãch c·ªßa h√¥m qua nh∆∞ng nh·∫≠p h√¥m nay = nh·∫≠p mu·ªôn
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                const testData = {
                    machine_id: 1, // M√°y ƒë·∫ßu ti√™n trong chi nh√°nh
                    coins_in: 8000,
                    coins_out: 6500,
                    note: `TEST: Giao d·ªãch ng√†y ${yesterdayStr} - ƒë√°nh d·∫•u nh·∫≠p mu·ªôn`,
                    transaction_date: yesterdayStr // Giao d·ªãch h√¥m qua = nh·∫≠p mu·ªôn theo logic m·ªõi
                };

                const response = await fetch(`${API_BASE}/api/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ƒê√£ t·∫°o test data: ${result.message}. ‚ö†Ô∏è ƒê√¢y l√† giao d·ªãch NH·∫¨P MU·ªòN!`);
                    loadTransactions(); // Reload ƒë·ªÉ th·∫•y data m·ªõi
                    loadDashboard(); // Reload dashboard ƒë·ªÉ th·∫•y stats m·ªõi
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('L·ªói t·∫°o test data:', error);
                showAlert('L·ªói khi t·∫°o test data', 'error');
            }
        }

        // Export current filtered data to Excel
        async function exportCurrentData() {
            try {
                // Get current filter values
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                const branchId = document.getElementById('dashboard_branch_id')?.value;
                
                // Determine period for filename
                let periodName = '';
                const activeQuickFilter = document.querySelector('.quick-filter-btn.active');
                if (activeQuickFilter) {
                    const period = activeQuickFilter.dataset.period;
                    switch(period) {
                        case 'today': periodName = 'hom-nay'; break;
                        case 'yesterday': periodName = 'hom-qua'; break;
                        case 'week': periodName = '7-ngay-qua'; break;
                        case 'month': periodName = 'thang-nay'; break;
                        default: periodName = `${startDate}-${endDate}`;
                    }
                } else {
                    periodName = `${startDate}-${endDate}`;
                }
                
                // Show loading state
                const exportBtn = document.querySelector('#export_section button');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '‚è≥ ƒêang xu·∫•t...';
                exportBtn.disabled = true;
                
                const url = new URL(`${window.location.origin}/api/export/csv`);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                if (branchId) url.searchParams.append('branch_id', branchId);

                console.log('üìÑ Export URL:', url.toString());

                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (response.ok) {
                    // T·∫°o blob t·ª´ response
                    const blob = await response.blob();
                    
                    // T·∫°o URL download
                    const downloadUrl = window.URL.createObjectURL(blob);
                    
                    // T·∫°o link download v√† click
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `doanh-thu-${periodName}-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);
                    
                    showAlert(`‚úÖ Xu·∫•t file Excel th√†nh c√¥ng! Kho·∫£ng th·ªùi gian: ${startDate} ƒë·∫øn ${endDate}`);
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'L·ªói khi xu·∫•t file', 'error');
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showAlert('L·ªói khi xu·∫•t file Excel', 'error');
            } finally {
                // Restore button state
                const exportBtn = document.querySelector('#export_section button');
                exportBtn.innerHTML = 'üìÑ Export Excel';
                exportBtn.disabled = false;
            }
        }

        // Debug function cho Admin
        async function debugTransactions() {
            try {
                const response = await fetch('/api/transactions?limit=10', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                console.log('üîß DEBUG - Raw transaction data:', data);
                
                const transactions = data.transactions || data;
                if (transactions.length === 0) {
                    alert('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu giao d·ªãch n√†o!\n\nH√£y t·∫°o d·ªØ li·ªáu test:\n1. Login nh√¢n vi√™n (nv001/123456)\n2. T·∫°o giao d·ªãch v·ªõi ng√†y kh√°c nhau\n3. Quay l·∫°i Admin ƒë·ªÉ xem');
                    return;
                }
                
                let debugInfo = 'üîß DEBUG INFO:\n\n';
                transactions.slice(0, 3).forEach((t, i) => {
                    debugInfo += `Giao d·ªãch ${i+1}:\n`;
                    debugInfo += `- Machine: ${t.machine_name}\n`;
                    debugInfo += `- User: ${t.user_name}\n`;
                    debugInfo += `- Transaction Date: ${t.transaction_date}\n`;
                    debugInfo += `- Created At: ${t.created_at}\n`;
                    debugInfo += `- Late Entry: ${t.transaction_date !== t.created_at.split('T')[0] ? 'YES ‚ö†Ô∏è' : 'NO ‚úÖ'}\n\n`;
                });
                
                alert(debugInfo);
                
            } catch (error) {
                console.error('Debug error:', error);
                alert('‚ùå L·ªói debug: ' + error.message);
            }
        }

        // Reset d·ªØ li·ªáu chi nh√°nh (ch·ªâ d√†nh cho Manager)
        async function resetData() {
            try {
                // X√°c nh·∫≠n tr∆∞·ªõc khi reset
                const branchName = currentUser.branch_name || 'chi nh√°nh n√†y';
                const confirmMessage = `‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò d·ªØ li·ªáu giao d·ªãch c·ªßa ${branchName}?\n\n` +
                                     `H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!\n\n` +
                                     `Nh·∫≠p "XAC NHAN" ƒë·ªÉ ti·∫øp t·ª•c:`;
                
                const userInput = prompt(confirmMessage);
                
                if (userInput !== 'XAC NHAN') {
                    showAlert('‚ùå ƒê√£ h·ªßy thao t√°c reset d·ªØ li·ªáu');
                    return;
                }

                // Hi·ªÉn th·ªã loading
                const resetButton = document.querySelector('#reset_section button');
                const originalText = resetButton.innerHTML;
                resetButton.innerHTML = '‚è≥ ƒêang reset...';
                resetButton.disabled = true;

                const response = await fetch('/api/reset-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(`‚úÖ ${result.message}`, 'success');
                    
                    // Reload d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
                    loadDashboard();
                    loadTransactions();
                } else {
                    showAlert(result.error || 'L·ªói khi reset d·ªØ li·ªáu', 'error');
                }

            } catch (error) {
                console.error('Error resetting data:', error);
                showAlert('L·ªói khi reset d·ªØ li·ªáu', 'error');
            } finally {
                // Kh√¥i ph·ª•c button
                const resetButton = document.querySelector('#reset_section button');
                resetButton.innerHTML = 'üóëÔ∏è Reset D·ªØ Li·ªáu';
                resetButton.disabled = false;
            }
        }
    </script>
</body>
</html> 