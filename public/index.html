<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Manager - Quản Lý Máy Chơi Game</title>
    
    <!-- PWA Meta Tags cho iPhone -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Game Manager">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    
    <!-- iPhone/iPad Splash Screens -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-startup-image" href="/icons/splash-2048x2732.svg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1668x2388.svg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1536x2048.svg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1284x2778.svg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1170x2532.svg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1125x2436.svg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-828x1792.svg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-750x1334.svg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    
    <!-- Apple Touch Icons cho tất cả devices - PNG format cho iOS -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/icons/icon-57x57.png">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Machine Selector Styles */
        .machine-selector {
            position: relative;
        }

        .machine-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .machine-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }

        .machine-option:hover {
            background-color: #f8f9fa;
        }

        .machine-option:last-child {
            border-bottom: none;
        }

        .machine-option.selected {
            background-color: #667eea;
            color: white;
        }

        .machine-option .machine-name {
            font-weight: bold;
            color: #333;
        }

        .machine-option.selected .machine-name {
            color: white;
        }

        .machine-option .machine-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
        }

        .machine-option.selected .machine-details {
            color: #e9ecef;
        }

        .selected-machine {
            margin-top: 10px;
            padding: 12px 15px;
            background: #e8f4fd;
            border: 1px solid #667eea;
            border-radius: 8px;
            font-weight: bold;
            color: #0d47a1;
        }

        .selected-machine .clear-selection {
            float: right;
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            padding: 0;
            margin: 0;
        }

        /* Mobile layout tối ưu - gọn gàng và ngang */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                overflow-x: hidden;
                /* iPhone specific optimizations */
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Fix for iPhone safe areas */
            .container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            
            /* ... existing code ... */
        }

        /* Tối ưu riêng cho iPhone (375px - 428px width) */
        @media screen and (min-width: 375px) and (max-width: 428px) {
            /* Fix viewport height cho iPhone */
            body {
                min-height: 100vh;
                min-height: -webkit-fill-available;
            }
            
            html {
                height: -webkit-fill-available;
            }
            
            /* Tối ưu header cho iPhone */
            .header {
                padding: 10px 0;
                margin-bottom: 10px;
            }
            
            .header-title h1 {
                font-size: 1.5em !important;
            }
            
            /* Tab container tối ưu */
            .tab-container {
                border-radius: 12px;
                margin: 0 -5px; /* Full width on iPhone */
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                padding: 12px 16px;
                font-size: 14px;
                white-space: nowrap;
            }
            
            /* Form inputs tối ưu cho iPhone */
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px !important; /* Ngăn zoom */
                padding: 14px !important;
                border-radius: 10px !important;
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* Select dropdown arrow cho iPhone */
            .form-group select {
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 10px center;
                background-size: 20px;
                padding-right: 40px !important;
            }
            
            /* Button tối ưu */
            .btn {
                min-height: 44px; /* Apple HIG recommendation */
                font-size: 16px !important;
                font-weight: 600;
                padding: 12px 20px !important;
                border-radius: 10px !important;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                touch-action: manipulation;
            }
            
            /* Stats grid cho iPhone */
            .stats-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
                margin-bottom: 15px !important;
            }
            
            .stat-card {
                padding: 12px 8px !important;
                min-height: 90px !important;
                border-radius: 12px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
            }
            
            .stat-card h3 {
                font-size: 1.3rem !important;
                font-weight: 700 !important;
                margin-bottom: 4px !important;
            }
            
            .stat-card p {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
                opacity: 0.85;
            }
            
            /* Machine list tối ưu */
            .machine-item {
                padding: 12px !important;
                margin-bottom: 8px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
            }
            
            .machine-item strong {
                font-size: 15px !important;
            }
            
            .machine-item small {
                font-size: 12px !important;
                line-height: 1.3 !important;
            }
            
            /* Transaction items */
            .transaction-item {
                padding: 12px !important;
                margin-bottom: 8px !important;
                border-radius: 10px !important;
            }
            
            .transaction-header {
                margin-bottom: 8px !important;
            }
            
            .transaction-info h4 {
                font-size: 15px !important;
            }
            
            .transaction-info .meta {
                font-size: 12px !important;
            }
            
            .transaction-amount .revenue {
                font-size: 1.1rem !important;
                font-weight: 700 !important;
            }
            
            /* Alert messages */
            .alert {
                font-size: 14px !important;
                padding: 12px 15px !important;
                border-radius: 10px !important;
            }
            
            /* Machine dropdown */
            .machine-dropdown {
                max-height: 250px !important;
                border-radius: 10px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            }
            
            .machine-option {
                padding: 14px 12px !important;
                font-size: 15px !important;
            }
            
            .machine-option .machine-name {
                font-size: 16px !important;
            }
            
            .machine-option .machine-details {
                font-size: 13px !important;
            }
            
            /* Quick filter buttons */
            .quick-filter-buttons {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .quick-filter-btn {
                padding: 12px 8px !important;
                border-radius: 10px !important;
                min-height: 60px !important;
            }
            
            /* Scrollable areas */
            .transaction-history {
                max-height: 60vh !important;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Fix cho notch và home indicator */
            @supports (padding: max(0px)) {
                .container {
                    padding-left: max(5px, env(safe-area-inset-left));
                    padding-right: max(5px, env(safe-area-inset-right));
                    padding-bottom: max(20px, env(safe-area-inset-bottom));
                }
                
                .tab-container {
                    margin-bottom: max(10px, env(safe-area-inset-bottom));
                }
            }
        }
        
        /* Landscape mode cho iPhone */
        @media screen and (max-width: 844px) and (orientation: landscape) {
            body {
                padding: 5px 20px;
            }
            
            .header {
                margin-bottom: 10px;
            }
            
            .header-title h1 {
                font-size: 1.3em !important;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .stat-card {
                padding: 10px 8px !important;
                min-height: 70px !important;
            }
            
            .stat-card h3 {
                font-size: 1.1rem !important;
            }
            
            .stat-card p {
                font-size: 0.7rem !important;
            }
            
            .tab-content {
                padding: 15px !important;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .transaction-history {
                max-height: calc(100vh - 200px) !important;
            }
            
            /* Safe areas cho landscape */
            @supports (padding: max(0px)) {
                body {
                    padding-left: max(20px, env(safe-area-inset-left));
                    padding-right: max(20px, env(safe-area-inset-right));
                }
            }
        }
        
        /* Dark mode support cho iPhone */
        @media (prefers-color-scheme: dark) {
            /* Giữ nguyên light mode vì app đã có màu sắc riêng */
        }
        
        /* Smooth scrolling cho iPhone */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevent text selection on buttons */
        .btn, .tab, button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* iPhone X và sau - notch handling */
        @supports (padding: max(0px)) {
            @media screen and (min-width: 375px) and (min-height: 812px) {
                .header {
                    padding-top: max(10px, env(safe-area-inset-top));
                }
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            color: white;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            text-align: left;
        }

        .header-title h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-user {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 15px;
            text-align: right;
        }

        .header-user h3 {
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .header-user p {
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* History Summary Styles */
        .history-summary {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .summary-card h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.5em;
        }

        .summary-card p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        /* Improved Transaction Item Styles */
        .transaction-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .transaction-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.1em;
        }

        .transaction-info .meta {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .transaction-amount {
            text-align: right;
        }

        .transaction-amount .revenue {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .transaction-amount .coins {
            font-size: 0.9em;
            color: #666;
        }

        .transaction-footer {
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .transaction-footer span {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .late-entry-warning {
            color: #ff6b35 !important;
            background: #fff3cd !important;
            border-color: #ffeaa7 !important;
            font-weight: bold;
        }

        .date-group {
            background: #f8f9fa;
            padding: 10px 15px;
            margin: 20px 0 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .date-group h3 {
            margin: 0;
            color: #333;
            font-size: 1.1em;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            background: #f8f9fa;
            color: #ccc;
            cursor: not-allowed;
        }

        .pagination span {
            color: #666;
            font-size: 0.9em;
        }

        .tab-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab-content {
            padding: 30px;
            min-height: 400px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Quick Filter Buttons Styles */
        .quick-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-color: #2196f3 !important;
        }

        .quick-filter-btn.active {
            background: #e3f2fd !important;
            border-color: #2196f3 !important;
            border-width: 3px !important;
        }

        .quick-filter-btn.active div:nth-child(2) {
            color: #1976d2 !important;
        }

                 /* Mobile responsive cho quick filters */
        @media (max-width: 768px) {
            .quick-filter-buttons {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .quick-filter-btn {
                padding: 10px 6px !important;
                font-size: 0.8em !important;
            }
            
            .quick-filter-btn div:first-child {
                font-size: 1.2em !important;
            }
            
            .quick-filter-btn div:nth-child(2) {
                font-size: 0.9em !important;
                margin: 3px 0 !important;
            }
            
            .quick-filter-btn div:last-child {
                font-size: 0.7em !important;
            }

            /* Action buttons responsive */
            .action-buttons {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .action-buttons > div {
                flex: none !important;
                width: 100% !important;
                text-align: left !important;
            }
            
            .action-buttons button {
                width: 100% !important;
                min-width: auto !important;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Mobile responsive cho stats-grid */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 15px;
                min-height: 80px;
            }
            
            .stat-card h3 {
                font-size: 1.2rem;
                margin-bottom: 5px;
            }
            
            .stat-card p {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 6px !important;
            }
            
            .stat-card {
                padding: 8px 4px !important;
                min-height: 70px !important;
            }
            
            .stat-card h3 {
                font-size: 1rem !important;
                margin-bottom: 2px !important;
            }
            
            .stat-card p {
                font-size: 0.65rem !important;
                line-height: 1.1 !important;
            }
        }

        /* Đặc biệt cho iPhone và thiết bị di động - hiển thị nằm ngang như laptop */
        @media screen and (max-width: 767px) {
            .stats-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                grid-template-rows: auto !important;
                gap: 8px !important;
                width: 100% !important;
                margin-bottom: 20px !important;
            }
            
            .stat-card {
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                min-height: 80px !important;
                max-width: none !important;
                width: 100% !important;
                box-sizing: border-box !important;
                padding: 10px 5px !important;
            }
            
            .stat-card h3 {
                font-size: 1.2rem !important;
                margin-bottom: 4px !important;
                line-height: 1.1 !important;
            }
            
            .stat-card p {
                font-size: 0.7rem !important;
                line-height: 1.2 !important;
                text-align: center !important;
                margin: 0 !important;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .machine-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .machine-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid transparent;
        }

        .machine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .machine-item[data-revenue="positive"] {
            border-left-color: #28a745;
        }

        .machine-item[data-revenue="negative"] {
            border-left-color: #dc3545;
        }

        .machine-item[data-revenue="zero"] {
            border-left-color: #6c757d;
        }

        .transaction-history {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .transaction-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters > div {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 8px 0;
            }
            
            .header-title h1 {
                font-size: 1.4rem;
            }
            
            .header-title p {
                font-size: 0.9rem !important;
                margin-bottom: 0 !important;
            }
            
            .tab-container {
                margin-top: 10px;
            }
            
            .tabs {
                flex-wrap: nowrap;
                gap: 2px;
            }
            
            .tab {
                flex: 1;
                min-width: 80px;
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            
            .tab-content {
                padding: 15px !important;
                min-height: auto !important;
            }
            
            .tab-content h2 {
                font-size: 1.2rem !important;
                margin-bottom: 10px !important;
            }
            
            .filters {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .filters .form-group {
                flex: 1;
                min-width: 150px;
                margin-bottom: 8px;
            }
            
            .form-group {
                width: 100%;
                margin-bottom: 12px;
            }
            
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 4px;
            }
            
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px;
                font-size: 16px; /* Ngăn zoom trên iOS */
                border-radius: 8px;
            }
            
            .form-group small {
                font-size: 0.8rem;
                line-height: 1.2;
            }
            
            .btn {
                width: 100%;
                padding: 10px;
                font-size: 0.95rem;
                margin-top: 8px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .machine-item {
                padding: 8px;
                margin-bottom: 6px;
                font-size: 0.85rem;
            }
            
            .transaction-item {
                padding: 8px;
                font-size: 0.85rem;
                margin-bottom: 6px;
            }

            /* Compact layout cho mobile */
            .machine-list {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }
            
            .transaction-history {
                max-height: 300px !important;
                padding: 10px !important;
            }
            
            /* Machine item compact */
            .machine-item h4 {
                font-size: 0.9rem !important;
                margin-bottom: 2px !important;
            }
            
            .machine-item .revenue {
                font-size: 1rem !important;
            }
            
            .machine-item small {
                font-size: 0.75rem !important;
                line-height: 1.1 !important;
            }
            
            /* Transaction item compact */
            .transaction-header {
                margin-bottom: 6px !important;
            }
            
            .transaction-info h4 {
                font-size: 0.9rem !important;
                margin-bottom: 2px !important;
            }
            
            .transaction-info .meta {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
            }
            
            .transaction-amount .revenue {
                font-size: 1rem !important;
            }
            
            .transaction-amount .coins {
                font-size: 0.75rem !important;
            }
            
            .transaction-footer {
                padding-top: 4px !important;
                margin-top: 4px !important;
                font-size: 0.75rem !important;
            }
            
            .date-group {
                padding: 6px 10px !important;
                margin: 10px 0 6px 0 !important;
                font-size: 0.9rem !important;
            }
            
            /* Tối ưu grid layout cho results */
            .stats-grid {
                margin-bottom: 10px !important;
            }
            
            /* Touch-friendly buttons */
            .tab,
            .btn,
            button {
                min-height: 40px;
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* Mobile responsive basic */
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 8px;
            }
            
            .header {
                margin-bottom: 15px;
            }
            
            .header-title h1 {
                font-size: 1.6em !important;
                margin-bottom: 8px !important;
            }
            
            .header-content {
                flex-direction: column !important;
                gap: 15px !important;
            }
            
            .header-user {
                padding: 12px 15px !important;
                text-align: center !important;
                border-radius: 12px !important;
                width: 100% !important;
            }
            
            .header-user h3 {
                font-size: 1em !important;
                margin-bottom: 5px !important;
            }
            
            .header-user p {
                font-size: 0.9em !important;
                margin-bottom: 8px !important;
            }
            
            .btn-logout {
                padding: 8px 15px !important;
                font-size: 14px !important;
                width: 100% !important;
            }

            /* Tối ưu form cho mobile */
            .form-group {
                margin-bottom: 20px !important;
            }

            .form-group label {
                font-size: 1.1em !important;
                font-weight: 600 !important;
                margin-bottom: 8px !important;
            }

            .form-group input, .form-group select, .form-group textarea {
                font-size: 16px !important; /* Ngăn zoom trên iPhone */
                padding: 15px !important;
                border-radius: 10px !important;
                height: auto !important;
            }

            .machine-dropdown {
                font-size: 16px;
            }

            .machine-option {
                padding: 15px 12px;
                font-size: 16px;
            }

            .btn {
                font-size: 16px !important;
                padding: 15px 20px !important;
                border-radius: 12px !important;
                width: 100% !important;
                margin-bottom: 10px !important;
            }

            /* Tab navigation cho mobile */
            .tab-nav {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 5px !important;
                margin-bottom: 20px !important;
            }

            .tab-nav button {
                flex: 1 !important;
                min-width: 0 !important;
                font-size: 14px !important;
                padding: 12px 8px !important;
                border-radius: 8px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
        }

        /* Tối ưu riêng cho iPhone (375px - 428px width) */
        @media screen and (min-width: 375px) and (max-width: 428px) {
            /* Fix viewport height cho iPhone */
            body {
                min-height: 100vh;
                min-height: -webkit-fill-available;
            }
            
            html {
                height: -webkit-fill-available;
            }
            
            /* Tối ưu header cho iPhone */
            .header {
                padding: 10px 0;
                margin-bottom: 10px;
            }
            
            .header-title h1 {
                font-size: 1.5em !important;
            }
            
            /* Tab container tối ưu */
            .tab-container {
                border-radius: 12px;
                margin: 0 -5px; /* Full width on iPhone */
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                padding: 12px 16px;
                font-size: 14px;
                white-space: nowrap;
            }
            
            /* Form inputs tối ưu cho iPhone */
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px !important; /* Ngăn zoom */
                padding: 14px !important;
                border-radius: 10px !important;
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* Select dropdown arrow cho iPhone */
            .form-group select {
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 10px center;
                background-size: 20px;
                padding-right: 40px !important;
            }
            
            /* Button tối ưu */
            .btn {
                min-height: 44px; /* Apple HIG recommendation */
                font-size: 16px !important;
                font-weight: 600;
                padding: 12px 20px !important;
                border-radius: 10px !important;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                touch-action: manipulation;
            }
            
            /* Stats grid cho iPhone */
            .stats-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
                margin-bottom: 15px !important;
            }
            
            .stat-card {
                padding: 12px 8px !important;
                min-height: 90px !important;
                border-radius: 12px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
            }
            
            .stat-card h3 {
                font-size: 1.3rem !important;
                font-weight: 700 !important;
                margin-bottom: 4px !important;
            }
            
            .stat-card p {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
                opacity: 0.85;
            }
            
            /* Machine list tối ưu */
            .machine-item {
                padding: 12px !important;
                margin-bottom: 8px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
            }
            
            .machine-item strong {
                font-size: 15px !important;
            }
            
            .machine-item small {
                font-size: 12px !important;
                line-height: 1.3 !important;
            }
            
            /* Transaction items */
            .transaction-item {
                padding: 12px !important;
                margin-bottom: 8px !important;
                border-radius: 10px !important;
            }
            
            .transaction-header {
                margin-bottom: 8px !important;
            }
            
            .transaction-info h4 {
                font-size: 15px !important;
            }
            
            .transaction-info .meta {
                font-size: 12px !important;
            }
            
            .transaction-amount .revenue {
                font-size: 1.1rem !important;
                font-weight: 700 !important;
            }
            
            /* Alert messages */
            .alert {
                font-size: 14px !important;
                padding: 12px 15px !important;
                border-radius: 10px !important;
            }
            
            /* Machine dropdown */
            .machine-dropdown {
                max-height: 250px !important;
                border-radius: 10px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            }
            
            .machine-option {
                padding: 14px 12px !important;
                font-size: 15px !important;
            }
            
            .machine-option .machine-name {
                font-size: 16px !important;
            }
            
            .machine-option .machine-details {
                font-size: 13px !important;
            }
            
            /* Quick filter buttons */
            .quick-filter-buttons {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .quick-filter-btn {
                padding: 12px 8px !important;
                border-radius: 10px !important;
                min-height: 60px !important;
            }
            
            /* Scrollable areas */
            .transaction-history {
                max-height: 60vh !important;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Fix cho notch và home indicator */
            @supports (padding: max(0px)) {
                .container {
                    padding-left: max(5px, env(safe-area-inset-left));
                    padding-right: max(5px, env(safe-area-inset-right));
                    padding-bottom: max(20px, env(safe-area-inset-bottom));
                }
                
                .tab-container {
                    margin-bottom: max(10px, env(safe-area-inset-bottom));
                }
            }
        }
        
        /* Landscape mode cho iPhone */
        @media screen and (max-width: 844px) and (orientation: landscape) {
            body {
                padding: 5px 20px;
            }
            
            .header {
                margin-bottom: 10px;
            }
            
            .header-title h1 {
                font-size: 1.3em !important;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .stat-card {
                padding: 10px 8px !important;
                min-height: 70px !important;
            }
            
            .stat-card h3 {
                font-size: 1.1rem !important;
            }
            
            .stat-card p {
                font-size: 0.7rem !important;
            }
            
            .tab-content {
                padding: 15px !important;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .transaction-history {
                max-height: calc(100vh - 200px) !important;
            }
            
            /* Safe areas cho landscape */
            @supports (padding: max(0px)) {
                body {
                    padding-left: max(20px, env(safe-area-inset-left));
                    padding-right: max(20px, env(safe-area-inset-right));
                }
            }
        }
        
        /* Dark mode support cho iPhone */
        @media (prefers-color-scheme: dark) {
            /* Giữ nguyên light mode vì app đã có màu sắc riêng */
        }
        
        /* Smooth scrolling cho iPhone */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevent text selection on buttons */
        .btn, .tab, button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* iPhone X và sau - notch handling */
        @supports (padding: max(0px)) {
            @media screen and (min-width: 375px) and (min-height: 812px) {
                .header {
                    padding-top: max(10px, env(safe-area-inset-top));
                }
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            color: white;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            text-align: left;
        }

        .header-title h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-user {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 15px;
            text-align: right;
        }

        .header-user h3 {
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .header-user p {
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* History Summary Styles */
        .history-summary {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .summary-card h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.5em;
        }

        .summary-card p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        /* Improved Transaction Item Styles */
        .transaction-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .transaction-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.1em;
        }

        .transaction-info .meta {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .transaction-amount {
            text-align: right;
        }

        .transaction-amount .revenue {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .transaction-amount .coins {
            font-size: 0.9em;
            color: #666;
        }

        .transaction-footer {
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .transaction-footer span {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .late-entry-warning {
            color: #ff6b35 !important;
            background: #fff3cd !important;
            border-color: #ffeaa7 !important;
            font-weight: bold;
        }

        .date-group {
            background: #f8f9fa;
            padding: 10px 15px;
            margin: 20px 0 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .date-group h3 {
            margin: 0;
            color: #333;
            font-size: 1.1em;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            background: #f8f9fa;
            color: #ccc;
            cursor: not-allowed;
        }

        .pagination span {
            color: #666;
            font-size: 0.9em;
        }

        .tab-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab-content {
            padding: 30px;
            min-height: 400px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Quick Filter Buttons Styles */
        .quick-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-color: #2196f3 !important;
        }

        .quick-filter-btn.active {
            background: #e3f2fd !important;
            border-color: #2196f3 !important;
            border-width: 3px !important;
        }

        .quick-filter-btn.active div:nth-child(2) {
            color: #1976d2 !important;
        }

                 /* Mobile responsive cho quick filters */
        @media (max-width: 768px) {
            .quick-filter-buttons {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .quick-filter-btn {
                padding: 10px 6px !important;
                font-size: 0.8em !important;
            }
            
            .quick-filter-btn div:first-child {
                font-size: 1.2em !important;
            }
            
            .quick-filter-btn div:nth-child(2) {
                font-size: 0.9em !important;
                margin: 3px 0 !important;
            }
            
            .quick-filter-btn div:last-child {
                font-size: 0.7em !important;
            }

            /* Action buttons responsive */
            .action-buttons {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .action-buttons > div {
                flex: none !important;
                width: 100% !important;
                text-align: left !important;
            }
            
            .action-buttons button {
                width: 100% !important;
                min-width: auto !important;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Mobile responsive cho stats-grid */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 15px;
                min-height: 80px;
            }
            
            .stat-card h3 {
                font-size: 1.2rem;
                margin-bottom: 5px;
            }
            
            .stat-card p {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 6px !important;
            }
            
            .stat-card {
                padding: 8px 4px !important;
                min-height: 70px !important;
            }
            
            .stat-card h3 {
                font-size: 1rem !important;
                margin-bottom: 2px !important;
            }
            
            .stat-card p {
                font-size: 0.65rem !important;
                line-height: 1.1 !important;
            }
        }

        /* Đặc biệt cho iPhone và thiết bị di động - hiển thị nằm ngang như laptop */
        @media screen and (max-width: 767px) {
            .stats-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                grid-template-rows: auto !important;
                gap: 8px !important;
                width: 100% !important;
                margin-bottom: 20px !important;
            }
            
            .stat-card {
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                min-height: 80px !important;
                max-width: none !important;
                width: 100% !important;
                box-sizing: border-box !important;
                padding: 10px 5px !important;
            }
            
            .stat-card h3 {
                font-size: 1.2rem !important;
                margin-bottom: 4px !important;
                line-height: 1.1 !important;
            }
            
            .stat-card p {
                font-size: 0.7rem !important;
                line-height: 1.2 !important;
                text-align: center !important;
                margin: 0 !important;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .machine-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .machine-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid transparent;
        }

        .machine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .machine-item[data-revenue="positive"] {
            border-left-color: #28a745;
        }

        .machine-item[data-revenue="negative"] {
            border-left-color: #dc3545;
        }

        .machine-item[data-revenue="zero"] {
            border-left-color: #6c757d;
        }

        .transaction-history {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .transaction-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters > div {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 8px 0;
            }
            
            .header-title h1 {
                font-size: 1.4rem;
            }
            
            .header-title p {
                font-size: 0.9rem !important;
                margin-bottom: 0 !important;
            }
            
            .tab-container {
                margin-top: 10px;
            }
            
            .tabs {
                flex-wrap: nowrap;
                gap: 2px;
            }
            
            .tab {
                flex: 1;
                min-width: 80px;
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            
            .tab-content {
                padding: 15px !important;
                min-height: auto !important;
            }
            
            .tab-content h2 {
                font-size: 1.2rem !important;
                margin-bottom: 10px !important;
            }
            
            .filters {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .filters .form-group {
                flex: 1;
                min-width: 150px;
                margin-bottom: 8px;
            }
            
            .form-group {
                width: 100%;
                margin-bottom: 12px;
            }
            
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 4px;
            }
            
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px;
                font-size: 16px; /* Ngăn zoom trên iOS */
                border-radius: 8px;
            }
            
            .form-group small {
                font-size: 0.8rem;
                line-height: 1.2;
            }
            
            .btn {
                width: 100%;
                padding: 10px;
                font-size: 0.95rem;
                margin-top: 8px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .machine-item {
                padding: 8px;
                margin-bottom: 6px;
                font-size: 0.85rem;
            }
            
            .transaction-item {
                padding: 8px;
                font-size: 0.85rem;
                margin-bottom: 6px;
            }

            /* Compact layout cho mobile */
            .machine-list {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }
            
            .transaction-history {
                max-height: 300px !important;
                padding: 10px !important;
            }
            
            /* Machine item compact */
            .machine-item h4 {
                font-size: 0.9rem !important;
                margin-bottom: 2px !important;
            }
            
            .machine-item .revenue {
                font-size: 1rem !important;
            }
            
            .machine-item small {
                font-size: 0.75rem !important;
                line-height: 1.1 !important;
            }
            
            /* Transaction item compact */
            .transaction-header {
                margin-bottom: 6px !important;
            }
            
            .transaction-info h4 {
                font-size: 0.9rem !important;
                margin-bottom: 2px !important;
            }
            
            .transaction-info .meta {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
            }
            
            .transaction-amount .revenue {
                font-size: 1rem !important;
            }
            
            .transaction-amount .coins {
                font-size: 0.75rem !important;
            }
            
            .transaction-footer {
                padding-top: 4px !important;
                margin-top: 4px !important;
                font-size: 0.75rem !important;
            }
            
            .date-group {
                padding: 6px 10px !important;
                margin: 10px 0 6px 0 !important;
                font-size: 0.9rem !important;
            }
            
            /* Tối ưu grid layout cho results */
            .stats-grid {
                margin-bottom: 10px !important;
            }
            
            /* Touch-friendly buttons */
            .tab,
            .btn,
            button {
                min-height: 40px;
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* iPhone specific machine/branch items layout */
        @media screen and (min-width: 375px) and (max-width: 428px) {
            /* Machine list tối ưu */
            .machine-item {
                padding: 12px !important;
                margin-bottom: 8px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }
            
            .machine-item > div:first-child {
                flex: 1 !important;
                min-width: 0 !important;
            }
            
            .machine-item > div:last-child {
                flex-shrink: 0 !important;
                text-align: right !important;
                min-width: 80px !important;
            }
            
            .machine-item strong {
                font-size: 15px !important;
                display: block !important;
                margin-bottom: 4px !important;
                line-height: 1.2 !important;
            }
            
            .machine-item small {
                font-size: 11px !important;
                line-height: 1.3 !important;
                color: #666 !important;
                display: block !important;
                margin-top: 2px !important;
            }
            
            /* Compact stats display in machine items */
            .machine-item .revenue-stats {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-end !important;
                gap: 2px !important;
            }
            
            .machine-item .revenue-amount {
                font-size: 16px !important;
                font-weight: 700 !important;
                line-height: 1 !important;
            }
            
            .machine-item .revenue-details {
                font-size: 10px !important;
                color: #666 !important;
                line-height: 1 !important;
            }
            
            .machine-item .revenue-badge {
                font-size: 9px !important;
                padding: 2px 6px !important;
                border-radius: 8px !important;
                margin-top: 2px !important;
                line-height: 1 !important;
            }
            
            /* Branch items layout */
            .branch-item,
            .machine-item[data-type="branch"] {
                padding: 15px 12px !important;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
                border-left: 4px solid #667eea !important;
                margin-bottom: 10px !important;
            }
            
            .branch-item .branch-stats,
            .machine-item .branch-stats {
                display: grid !important;
                grid-template-columns: 1fr auto !important;
                gap: 15px !important;
                align-items: center !important;
            }
            
            .branch-info h4 {
                font-size: 16px !important;
                margin-bottom: 4px !important;
                color: #333 !important;
            }
            
            .branch-info .meta {
                font-size: 11px !important;
                color: #666 !important;
                line-height: 1.3 !important;
            }
            
            .branch-revenue {
                text-align: right !important;
            }
            
            .branch-revenue .amount {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: #28a745 !important;
                line-height: 1 !important;
            }
            
            .branch-revenue .details {
                font-size: 10px !important;
                color: #666 !important;
                margin-top: 2px !important;
                line-height: 1.2 !important;
            }
        }

        /* Mobile-first approach - apply to all mobile devices */
        @media screen and (max-width: 768px) {
            /* Machine list tối ưu - MOBILE HORIZONTAL LAYOUT */
            .machine-item {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                gap: 10px !important;
                padding: 12px !important;
                margin-bottom: 8px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
            }
            
            .machine-item > div:first-child {
                flex: 1 !important;
                min-width: 0 !important;
            }
            
            .machine-item > div:last-child {
                flex-shrink: 0 !important;
                text-align: right !important;
                min-width: 80px !important;
            }
            
            .machine-item strong {
                font-size: 15px !important;
                display: block !important;
                margin-bottom: 4px !important;
                line-height: 1.2 !important;
            }
            
            .machine-item small {
                font-size: 11px !important;
                line-height: 1.3 !important;
                color: #666 !important;
                display: block !important;
                margin-top: 2px !important;
            }
            
            /* Compact stats display in machine items */
            .machine-item .revenue-stats {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-end !important;
                gap: 2px !important;
            }
            
            .machine-item .revenue-amount {
                font-size: 16px !important;
                font-weight: 700 !important;
                line-height: 1 !important;
            }
            
            .machine-item .revenue-details {
                font-size: 10px !important;
                color: #666 !important;
                line-height: 1 !important;
            }
            
            .machine-item .revenue-badge {
                font-size: 9px !important;
                padding: 2px 6px !important;
                border-radius: 8px !important;
                margin-top: 2px !important;
                line-height: 1 !important;
            }
            
            /* Branch items layout */
            .branch-item,
            .machine-item[data-type="branch"] {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                padding: 15px 12px !important;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
                border-left: 4px solid #667eea !important;
                margin-bottom: 10px !important;
            }
            
            .branch-info h4 {
                font-size: 16px !important;
                margin-bottom: 4px !important;
                color: #333 !important;
            }
            
            .branch-info .meta,
            .branch-info small {
                font-size: 11px !important;
                color: #666 !important;
                line-height: 1.3 !important;
                display: block !important;
                margin-top: 2px !important;
            }
            
            .branch-revenue {
                text-align: right !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-end !important;
                gap: 2px !important;
            }
            
            .branch-revenue .amount {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: #28a745 !important;
                line-height: 1 !important;
            }
            
            .branch-revenue .details {
                font-size: 10px !important;
                color: #666 !important;
                margin-top: 2px !important;
                line-height: 1.2 !important;
            }
        }
        
        /* Force mobile layout even on larger screens for debugging */
        @media screen and (min-width: 768px) and (max-width: 1024px) {
            .machine-item {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>🎮 Quản Lý Máy Chơi Game</h1>
                    <p>Hệ thống theo dõi xu vào/ra và doanh thu</p>
                </div>
                <div class="header-user" id="header-user">
                    <!-- User info sẽ được load bằng JS -->
                </div>
            </div>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('entry')">Nhập Liệu</button>
                <button class="tab" onclick="showTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="showTab('history')">Lịch Sử</button>
            </div>

            <!-- Tab Nhập Liệu -->
            <div id="entry" class="tab-content">
                <h2>📊 Nhập Dữ Liệu Xu</h2>
                <div id="alert-container"></div>
                
                <form id="transactionForm">
                    <div class="form-group" id="branch_selector" style="display: none;">
                        <label for="form_branch_id">Chọn Chi Nhánh:</label>
                        <select id="form_branch_id">
                            <option value="">-- Chọn chi nhánh --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="machine_id">Chọn Máy:</label>
                        <div class="machine-selector">
                            <input type="text" id="machine_search" placeholder="🔍 Tìm máy (VD: 001, Tầng 1)..." autocomplete="off">
                            <select id="machine_id" required style="display: none;">
                                <option value="">-- Chọn máy chơi game --</option>
                            </select>
                            <div id="machine_dropdown" class="machine-dropdown" style="display: none;"></div>
                        </div>
                        <div id="selected_machine" class="selected-machine" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label for="transaction_date">Ngày Giao Dịch:</label>
                        <input type="date" id="transaction_date" required>
                        <small style="color: #666; font-size: 0.9em;">💡 Chọn ngày thực hiện giao dịch (có thể là hôm qua nếu quên nhập)</small>
                    </div>

                    <div class="form-group">
                        <label for="coins_in">💰 Coin In Total (Xu Vào):</label>
                        <input type="number" id="coins_in" min="0" value="0" required placeholder="VD: 70200" oninput="calculateProfit()">
                        <small style="color: #666;">Tổng số xu khách nạp vào máy</small>
                    </div>

                    <div class="form-group">
                        <label for="coins_out">💸 Coin Out Total (Xu Ra):</label>
                        <input type="number" id="coins_out" min="0" value="0" required placeholder="VD: 57000" oninput="calculateProfit()">
                        <small style="color: #666;">Tổng số xu khách thắng được</small>
                    </div>

                    <div class="form-group">
                        <label for="profit_display">📊 Total Profit (Lãi/Lỗ):</label>
                        <input type="text" id="profit_display" readonly style="background: #f8f9fa; font-weight: bold; font-size: 1.1em;" placeholder="Tự động tính = Xu Vào - Xu Ra">
                        <small style="color: #666;">Được tính tự động khi nhập xu vào/ra</small>
                    </div>

                    <div class="form-group">
                        <label for="note">📝 Ghi Chú (tùy chọn):</label>
                        <input type="text" id="note" placeholder="VD: Ca sáng, ca chiều, máy báo lỗi, thông tin đặc biệt...">
                        <small style="color: #666;">💡 Ghi chú thêm thông tin như ca làm việc, tình trạng máy, v.v.</small>
                    </div>

                    <button type="submit" class="btn">💾 Lưu Giao Dịch</button>
                    <a href="/guide.html" target="_blank" class="btn" style="background: #17a2b8; text-decoration: none; display: inline-block; margin-left: 10px;">📖 Hướng Dẫn Nhập Liệu</a>
                </form>
            </div>

            <!-- Tab Dashboard -->
            <div id="dashboard" class="tab-content" style="display: none;">
                <h2>📈 Dashboard Doanh Thu</h2>
                
                <!-- Quick Filter Buttons -->
                <div class="quick-filters" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #e9ecef;">
                    <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 1.1em;">⚡ Xem Nhanh</h3>
                    <div class="quick-filter-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <button class="quick-filter-btn" data-period="today" onclick="setQuickFilter('today')" style="padding: 12px 8px; border-radius: 8px; border: 2px solid #e9ecef; background: #fff; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em;">
                            <div style="font-size: 1.4em;">🕐</div>
                            <div style="font-weight: bold; margin: 5px 0;">HÔM NAY</div>
                            <div style="font-size: 0.8em; color: #6c757d;" id="today-date"></div>
                        </button>
                        <button class="quick-filter-btn" data-period="yesterday" onclick="setQuickFilter('yesterday')" style="padding: 12px 8px; border-radius: 8px; border: 2px solid #e9ecef; background: #fff; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em;">
                            <div style="font-size: 1.4em;">📅</div>
                            <div style="font-weight: bold; margin: 5px 0;">HÔM QUA</div>
                            <div style="font-size: 0.8em; color: #6c757d;" id="yesterday-date"></div>
                        </button>
                        <button class="quick-filter-btn" data-period="week" onclick="setQuickFilter('week')" style="padding: 12px 8px; border-radius: 8px; border: 2px solid #e9ecef; background: #fff; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em;">
                            <div style="font-size: 1.4em;">📊</div>
                            <div style="font-weight: bold; margin: 5px 0;">7 NGÀY QUA</div>
                            <div style="font-size: 0.8em; color: #6c757d;" id="week-date"></div>
                        </button>
                        <button class="quick-filter-btn" data-period="month" onclick="setQuickFilter('month')" style="padding: 12px 8px; border-radius: 8px; border: 2px solid #e9ecef; background: #fff; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em;">
                            <div style="font-size: 1.4em;">📈</div>
                            <div style="font-weight: bold; margin: 5px 0;">THÁNG NÀY</div>
                            <div style="font-size: 0.8em; color: #6c757d;" id="month-date"></div>
                        </button>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="loadDashboard()" style="background: #667eea; flex: 1; min-width: 120px;">
                        🔍 Cập Nhật Báo Cáo
                    </button>
                    <div id="export_section" style="display: none;">
                        <button type="button" class="btn" onclick="exportCurrentData()" style="background: #28a745; min-width: 140px;">
                            📄 Export Excel
                        </button>
                    </div>
                    <div id="reset_section" style="display: none;">
                        <button type="button" class="btn" onclick="resetData()" style="background: #dc3545; min-width: 120px;">
                            🗑️ Reset Dữ Liệu
                        </button>
                    </div>
                    <div style="flex: 1; text-align: right;">
                        <button type="button" id="toggle-advanced" onclick="toggleAdvancedFilters()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            🔧 Bộ Lọc Nâng Cao <span id="toggle-icon">▼</span>
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Filters (Collapsed by default) -->
                <div class="advanced-filters" style="margin-bottom: 20px;">
                    <div id="advanced-filter-content" class="filters" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div class="form-group" id="dashboard_branch_selector" style="display: none;">
                        <label for="dashboard_branch_id">Chi Nhánh:</label>
                        <select id="dashboard_branch_id">
                            <option value="">-- Tất cả chi nhánh --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="start_date">Từ Ngày:</label>
                        <input type="date" id="start_date">
                    </div>
                    <div class="form-group">
                        <label for="end_date">Đến Ngày:</label>
                        <input type="date" id="end_date">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn" onclick="loadDashboard()">🔍 Áp Dụng Bộ Lọc</button>
                    </div>
                    </div>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <!-- Stats sẽ được load bằng JavaScript -->
                </div>

                <div class="machine-list" id="machine-revenue">
                    <!-- Doanh thu theo máy sẽ được load bằng JavaScript -->
                </div>
            </div>

            <!-- Tab Lịch Sử -->
            <div id="history" class="tab-content" style="display: none;">
                <h2>📋 Lịch Sử Giao Dịch</h2>
                <div id="admin_info" style="display: none; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <strong>🔑 Chế độ Admin:</strong> Bạn có thể xem thông tin chi tiết về thời gian nhập liệu và ngày giao dịch của tất cả chi nhánh. 
                    Sử dụng các filter để tìm kiếm theo chi nhánh, nhân viên, hoặc giao dịch nhập muộn.
                    <button onclick="debugTransactions()" style="margin-left: 15px; background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">🔧 Debug Data</button>
                    <button onclick="createTestData()" style="margin-left: 5px; background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">➕ Tạo Test Data</button>
                </div>
                
                <div class="filters">
                    <div class="form-group" id="history_branch_selector" style="display: none;">
                        <label for="history_branch_id">Chi Nhánh:</label>
                        <select id="history_branch_id">
                            <option value="">-- Tất cả chi nhánh --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter_machine">Lọc Theo Máy:</label>
                        <select id="filter_machine">
                            <option value="">-- Tất cả máy --</option>
                        </select>
                    </div>
                    <div class="form-group" id="history_user_selector" style="display: none;">
                        <label for="history_user_id">Nhân Viên:</label>
                        <select id="history_user_id">
                            <option value="">-- Tất cả nhân viên --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="history_start_date">Từ Ngày:</label>
                        <input type="date" id="history_start_date">
                    </div>
                    <div class="form-group">
                        <label for="history_end_date">Đến Ngày:</label>
                        <input type="date" id="history_end_date">
                    </div>
                    <div class="form-group">
                        <label for="sort_by">Sắp Xếp:</label>
                        <select id="sort_by">
                            <option value="date_desc">Ngày mới nhất</option>
                            <option value="date_asc">Ngày cũ nhất</option>
                            <option value="revenue_desc">Doanh thu cao nhất</option>
                            <option value="revenue_asc">Doanh thu thấp nhất</option>
                        </select>
                    </div>
                    <div class="form-group" id="late_entry_filter" style="display: none;">
                        <label for="filter_late_entry">Lọc Nhập Muộn:</label>
                        <select id="filter_late_entry">
                            <option value="">-- Tất cả --</option>
                            <option value="late">Chỉ nhập muộn ⚠️</option>
                            <option value="ontime">Chỉ nhập đúng giờ ✅</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn" onclick="loadTransactions()">🔍 Tìm Kiếm</button>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn" onclick="clearHistoryFilters()" style="background: #6c757d;">🗑️ Xóa Filter</button>
                    </div>
                </div>

                <!-- Summary stats cho lịch sử -->
                <div class="history-summary" id="history-summary" style="display: none;">
                    <!-- Summary sẽ được load bằng JS -->
                </div>

                <div class="transaction-history" id="transaction-history">
                    <!-- Lịch sử giao dịch sẽ được load bằng JavaScript -->
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination" style="display: none;">
                    <!-- Pagination sẽ được load bằng JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = '';
        
        // Global user data
        let currentUser = null;

        // Initialize app and iPhone optimizations
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setDefaultDates();
            
            // Register service worker cho PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            }
            
            // Auto-load dashboard data with last 7 days
            const today = new Date();
            const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('start_date').value = sevenDaysAgo.toISOString().split('T')[0];
            document.getElementById('end_date').value = today.toISOString().split('T')[0];
            loadDashboard();
            
            // iPhone specific optimizations
            // Prevent zoom on input focus cho iPhone
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta) {
                viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            }
            
            // Fix 100vh issue on iPhone
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
            
            // Smooth scroll cho iOS
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // Touch feedback cho buttons
            const buttons = document.querySelectorAll('.btn, .tab, button');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.opacity = '0.7';
                });
                button.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
            });
            
            // Swipe gestures cho tabs
            let touchStartX = 0;
            let touchEndX = 0;
            const tabContainer = document.querySelector('.tab-container');
            
            if (tabContainer) {
                tabContainer.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                }, {passive: true});
                
                tabContainer.addEventListener('touchend', function(e) {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, {passive: true});
            }
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    const activeTab = document.querySelector('.tab.active');
                    const tabs = Array.from(document.querySelectorAll('.tab'));
                    const currentIndex = tabs.indexOf(activeTab);
                    
                    if (diff > 0 && currentIndex < tabs.length - 1) {
                        // Swipe left - next tab
                        tabs[currentIndex + 1].click();
                    } else if (diff < 0 && currentIndex > 0) {
                        // Swipe right - previous tab
                        tabs[currentIndex - 1].click();
                    }
                }
            }
            
            // Pull to refresh cho dashboard
            let pullStartY = 0;
            let isPulling = false;
            
            document.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, {passive: true});
            
            document.addEventListener('touchmove', function(e) {
                if (!isPulling) return;
                
                const pullDistance = e.touches[0].clientY - pullStartY;
                if (pullDistance > 100) {
                    document.body.style.transform = `translateY(${Math.min(pullDistance * 0.5, 80)}px)`;
                }
            }, {passive: true});
            
            document.addEventListener('touchend', function(e) {
                if (!isPulling) return;
                
                const pullDistance = e.changedTouches[0].clientY - pullStartY;
                document.body.style.transform = '';
                
                if (pullDistance > 150) {
                    // Refresh current tab
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab.textContent.includes('Dashboard')) {
                        loadDashboard();
                    } else if (activeTab.textContent.includes('Lịch Sử')) {
                        loadTransactions();
                    }
                }
                
                isPulling = false;
            }, {passive: true});
            
            // Auto-hide address bar on scroll
            window.scrollTo(0, 1);
            
            // Fix cho iOS input blur issue
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    window.scrollTo(0, 0);
                });
            });
            
            // Optimize images and icons cho Retina display
            if (window.devicePixelRatio > 1) {
                document.querySelectorAll('img').forEach(img => {
                    if (img.src.includes('.png') && !img.src.includes('@2x')) {
                        const highResUrl = img.src.replace('.png', '@2x.png');
                        // Check if high res version exists
                        const testImg = new Image();
                        testImg.onload = function() {
                            img.src = highResUrl;
                        };
                        testImg.src = highResUrl;
                    }
                });
            }
            
            // Haptic feedback cho iPhone (nếu supported)
            if ('vibrate' in navigator) {
                document.querySelectorAll('.btn, button').forEach(btn => {
                    btn.addEventListener('click', function() {
                        navigator.vibrate(10); // Light haptic feedback
                    });
                });
            }
        });

        // Tính toán profit tự động
        function calculateProfit() {
            const coinsIn = parseInt(document.getElementById('coins_in').value) || 0;
            const coinsOut = parseInt(document.getElementById('coins_out').value) || 0;
            const profit = coinsIn - coinsOut;
            
            const profitDisplay = document.getElementById('profit_display');
            if (coinsIn > 0 || coinsOut > 0) {
                profitDisplay.value = `${profit} xu`;
                
                // Đổi màu theo profit
                if (profit > 0) {
                    profitDisplay.style.color = '#28a745'; // Xanh = lãi
                    profitDisplay.style.background = '#d4edda';
                } else if (profit < 0) {
                    profitDisplay.style.color = '#dc3545'; // Đỏ = lỗ
                    profitDisplay.style.background = '#f8d7da';
                } else {
                    profitDisplay.style.color = '#6c757d'; // Xám = hòa vốn
                    profitDisplay.style.background = '#f8f9fa';
                }
            } else {
                profitDisplay.value = '';
                profitDisplay.style.color = '#333';
                profitDisplay.style.background = '#f8f9fa';
            }
        }

        // Kiểm tra authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/profile', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    initializeApp();
                } else {
                    // Chưa đăng nhập, chuyển đến trang login
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login.html';
            }
        }

        // Khởi tạo app sau khi đã auth
        function initializeApp() {
            updateUIForUserRole();
            loadBranches();
            loadMachines();
            loadDashboard();
            setDefaultDates();
        }

        // Cập nhật UI theo role người dùng
        function updateUIForUserRole() {
            if (!currentUser) return;

            // Cập nhật header user info
            const headerUser = document.getElementById('header-user');
            headerUser.innerHTML = `
                <h3>${currentUser.full_name}</h3>
                <p>${getRoleDisplayName(currentUser.role)}${currentUser.branch_name ? ' - ' + currentUser.branch_name : ''}</p>
                <button class="btn-logout" onclick="logout()">Đăng Xuất</button>
            `;

            // Hiển thị/ẩn các element theo role
            if (currentUser.role === 'admin') {
                // Admin thấy tất cả
                document.getElementById('branch_selector').style.display = 'block';
                document.getElementById('dashboard_branch_selector').style.display = 'block';
                document.getElementById('history_branch_selector').style.display = 'block';
                document.getElementById('history_user_selector').style.display = 'block';
                document.getElementById('export_section').style.display = 'block';
                document.getElementById('late_entry_filter').style.display = 'block';
                document.getElementById('admin_info').style.display = 'block';
                loadUsers(); // Load danh sách tất cả users cho admin
            } else if (currentUser.role === 'manager') {
                // Manager chỉ thấy chi nhánh mình và có thể export, reset
                document.getElementById('export_section').style.display = 'block';
                document.getElementById('reset_section').style.display = 'block';
                document.getElementById('history_user_selector').style.display = 'block';
                document.getElementById('late_entry_filter').style.display = 'block';
                
                // Hiển thị thông tin đặc biệt cho manager
                const managerInfo = document.getElementById('admin_info');
                if (managerInfo) {
                    managerInfo.style.display = 'block';
                    managerInfo.innerHTML = `
                        <strong>🏢 Chế độ Manager - ${currentUser.branch_name}:</strong> 
                        Bạn có thể xem thông tin chi tiết về thời gian nhập liệu và ngày giao dịch của nhân viên trong chi nhánh. 
                        Sử dụng filter "Lọc Nhập Muộn" để kiểm tra nhân viên nào nhập dữ liệu muộn.
                        <button onclick="debugTransactions()" style="margin-left: 15px; background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">🔧 Debug Data</button>
                        <button onclick="createTestData()" style="margin-left: 5px; background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">➕ Tạo Test Data</button>
                    `;
                }
                
                loadUsers(); // Load danh sách nhân viên cho manager
            } else {
                // Employee chỉ nhập liệu
                const dashboard = document.querySelector('.tab[onclick="showTab(\'dashboard\')"]');
                if (dashboard) dashboard.style.display = 'none';
            }
        }

        function getRoleDisplayName(role) {
            switch(role) {
                case 'admin': return 'Quản Trị Viên';
                case 'manager': return 'Quản Lý';
                case 'employee': return 'Nhân Viên';
                default: return role;
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // Xóa saved credentials khi logout
                localStorage.removeItem('saved_username');
                localStorage.removeItem('saved_password');
                localStorage.removeItem('remember_me');
                localStorage.removeItem('remember_expiry');
                
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout error:', error);
                
                // Vẫn xóa credentials dù có lỗi
                localStorage.removeItem('saved_username');
                localStorage.removeItem('saved_password');
                localStorage.removeItem('remember_me');
                localStorage.removeItem('remember_expiry');
                
                window.location.href = '/login.html';
            }
        }

        // Set ngày mặc định (hôm nay)
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('start_date').value = today;
            document.getElementById('end_date').value = today;
            document.getElementById('transaction_date').value = today;
            
            // Set default cho history filters - mở rộng thành 30 ngày
            document.getElementById('history_start_date').value = thirtyDaysAgo;
            document.getElementById('history_end_date').value = today;
            
            // Initialize quick filter dates and set default to "yesterday"
            initializeQuickFilterDates();
            setQuickFilter('yesterday');
        }

        // Initialize quick filter date displays
        function initializeQuickFilterDates() {
            const today = new Date();
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            // Update date displays
            document.getElementById('today-date').textContent = today.toLocaleDateString('vi-VN');
            document.getElementById('yesterday-date').textContent = yesterday.toLocaleDateString('vi-VN');
            document.getElementById('week-date').textContent = weekAgo.toLocaleDateString('vi-VN') + ' - ' + today.toLocaleDateString('vi-VN');
            document.getElementById('month-date').textContent = 'Tháng ' + (today.getMonth() + 1);
        }

        // Set quick filter for dashboard
        function setQuickFilter(period) {
            const today = new Date();
            let startDate, endDate;
            
            switch(period) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'yesterday':
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    startDate = endDate = yesterday.toISOString().split('T')[0];
                    break;
                case 'week':
                    endDate = today.toISOString().split('T')[0];
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    break;
                case 'month':
                    endDate = today.toISOString().split('T')[0];
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    break;
            }
            
            // Update form inputs
            document.getElementById('start_date').value = startDate;
            document.getElementById('end_date').value = endDate;
            
            // Update active button
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // Collapse advanced filters when using quick filter
            document.getElementById('advanced-filter-content').style.display = 'none';
            document.getElementById('toggle-icon').textContent = '▼';
            
            // Load dashboard with new dates
            loadDashboard();
        }

        // Toggle advanced filters
        function toggleAdvancedFilters() {
            const content = document.getElementById('advanced-filter-content');
            const icon = document.getElementById('toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▲';
                
                // Remove active state from quick filters when using advanced
                document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            } else {
                content.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        // Hiển thị tab
        function showTab(tabName) {
            // Ẩn tất cả tab content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.style.display = 'none');

            // Bỏ active class từ tất cả tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Hiển thị tab được chọn
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');

            // Load dữ liệu theo tab
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'history') {
                loadTransactions();
            }
        }

        // Hiển thị thông báo
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Load danh sách chi nhánh
        async function loadBranches() {
            try {
                const response = await fetch(`${API_BASE}/api/branches`, {
                    credentials: 'include'
                });
                const branches = await response.json();
                
                const selects = ['form_branch_id', 'dashboard_branch_id', 'history_branch_id'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    const currentValue = select.value;
                    
                    // Clear và thêm option mặc định
                    if (selectId === 'form_branch_id') {
                        select.innerHTML = '<option value="">-- Chọn chi nhánh --</option>';
                    } else {
                        select.innerHTML = '<option value="">-- Tất cả chi nhánh --</option>';
                    }
                    
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = branch.name;
                        select.appendChild(option);
                    });
                    
                    select.value = currentValue;
                });

                // Set up event listeners cho branch selectors
                const formBranchSelect = document.getElementById('form_branch_id');
                if (formBranchSelect) {
                    formBranchSelect.addEventListener('change', loadMachines);
                }

                const historyBranchSelect = document.getElementById('history_branch_id');
                if (historyBranchSelect) {
                    historyBranchSelect.addEventListener('change', loadMachines);
                }
                
            } catch (error) {
                console.error('Lỗi khi load chi nhánh:', error);
                showAlert('Lỗi khi tải danh sách chi nhánh', 'error');
            }
        }

        // Global variables cho machine selector
        let allMachines = [];
        let selectedMachine = null;

        // Load danh sách máy
        async function loadMachines() {
            try {
                // Lấy branch_id để filter
                const formBranchId = document.getElementById('form_branch_id')?.value;
                const historyBranchId = document.getElementById('history_branch_id')?.value;
                
                let url = `${API_BASE}/api/machines`;
                const params = new URLSearchParams();
                
                // Tùy theo context mà dùng branch_id khác nhau
                if (formBranchId) {
                    params.append('branch_id', formBranchId);
                } else if (historyBranchId) {
                    params.append('branch_id', historyBranchId);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const machines = await response.json();
                
                // Store machines globally cho search
                allMachines = machines;
                
                const selects = ['machine_id', 'filter_machine'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    const currentValue = select.value;
                    
                    // Clear và thêm option mặc định
                    select.innerHTML = selectId === 'machine_id' ? 
                        '<option value="">-- Chọn máy chơi game --</option>' :
                        '<option value="">-- Tất cả máy --</option>';
                    
                    machines.forEach(machine => {
                        const option = document.createElement('option');
                        option.value = machine.id;
                        option.textContent = `${machine.name} (${machine.location}) - ${machine.branch_name}`;
                        select.appendChild(option);
                    });
                    
                    select.value = currentValue;
                });

                // Initialize machine search cho form entry
                initMachineSearch();
                
            } catch (error) {
                console.error('Lỗi khi load máy:', error);
                showAlert('Lỗi khi tải danh sách máy chơi game', 'error');
            }
        }

        // Initialize machine search functionality
        function initMachineSearch() {
            const searchInput = document.getElementById('machine_search');
            const dropdown = document.getElementById('machine_dropdown');
            const hiddenSelect = document.getElementById('machine_id');
            const selectedDiv = document.getElementById('selected_machine');

            if (!searchInput || !dropdown) return;

            // Show dropdown khi focus vào search
            searchInput.addEventListener('focus', () => {
                showMachineDropdown();
            });

            // Search while typing
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                filterMachines(query);
            });

            // Hide dropdown khi click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.machine-selector')) {
                    dropdown.style.display = 'none';
                }
            });

            // Prevent form submission on Enter in search
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Select first visible option
                    const firstOption = dropdown.querySelector('.machine-option:not([style*="display: none"])');
                    if (firstOption) {
                        selectMachine(JSON.parse(firstOption.dataset.machine));
                    }
                }
            });
        }

        function showMachineDropdown() {
            const dropdown = document.getElementById('machine_dropdown');
            if (!dropdown || allMachines.length === 0) return;

            filterMachines(''); // Show all machines initially
            dropdown.style.display = 'block';
        }

        function filterMachines(query) {
            const dropdown = document.getElementById('machine_dropdown');
            if (!dropdown) return;

            const filteredMachines = allMachines.filter(machine => 
                machine.name.toLowerCase().includes(query) ||
                machine.location.toLowerCase().includes(query) ||
                machine.branch_name.toLowerCase().includes(query)
            );

            dropdown.innerHTML = '';

            if (filteredMachines.length === 0) {
                dropdown.innerHTML = '<div class="machine-option" style="color: #666;">Không tìm thấy máy nào</div>';
                return;
            }

            filteredMachines.forEach(machine => {
                const option = document.createElement('div');
                option.className = 'machine-option';
                option.dataset.machine = JSON.stringify(machine);
                option.innerHTML = `
                    <div class="machine-name">${machine.name}</div>
                    <div class="machine-details">📍 ${machine.location} | 🏢 ${machine.branch_name}</div>
                `;
                
                option.addEventListener('click', () => {
                    selectMachine(machine);
                });

                dropdown.appendChild(option);
            });
        }

        function selectMachine(machine) {
            selectedMachine = machine;
            
            const searchInput = document.getElementById('machine_search');
            const dropdown = document.getElementById('machine_dropdown');
            const hiddenSelect = document.getElementById('machine_id');
            const selectedDiv = document.getElementById('selected_machine');

            // Update search input
            searchInput.value = `${machine.name} - ${machine.location}`;
            
            // Update hidden select for form submission
            hiddenSelect.value = machine.id;
            
            // Show selected machine info
            selectedDiv.innerHTML = `
                🎮 <strong>${machine.name}</strong><br>
                📍 ${machine.location} | 🏢 ${machine.branch_name}
                <button type="button" class="clear-selection" onclick="clearMachineSelection()">✕</button>
            `;
            selectedDiv.style.display = 'block';
            
            // Hide dropdown
            dropdown.style.display = 'none';

            // Trigger change event for validation
            hiddenSelect.dispatchEvent(new Event('change'));
        }

        function clearMachineSelection() {
            selectedMachine = null;
            
            const searchInput = document.getElementById('machine_search');
            const hiddenSelect = document.getElementById('machine_id');
            const selectedDiv = document.getElementById('selected_machine');

            searchInput.value = '';
            hiddenSelect.value = '';
            selectedDiv.style.display = 'none';

            // Focus back to search
            searchInput.focus();
        }

        // Xử lý form thêm giao dịch
        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validation ngày
            const selectedDate = document.getElementById('transaction_date').value;
            const today = new Date().toISOString().split('T')[0];
            
            if (selectedDate > today) {
                showAlert('❌ Không thể nhập giao dịch cho ngày tương lai! Chỉ được nhập từ hôm nay trở về trước.', 'error');
                return;
            }
            
            // Cảnh báo nếu nhập muộn (ngày quá khứ)
            if (selectedDate < today) {
                const confirmLate = confirm(`⚠️ CẢNH BÁO: Bạn đang nhập giao dịch cho ngày ${selectedDate} (quá khứ).\n\nĐây sẽ được đánh dấu là "NHẬP MUỘN".\n\nBạn có chắc chắn muốn tiếp tục?`);
                if (!confirmLate) {
                    return;
                }
            }
            
            const formData = {
                machine_id: parseInt(document.getElementById('machine_id').value),
                coins_in: parseInt(document.getElementById('coins_in').value) || 0,
                coins_out: parseInt(document.getElementById('coins_out').value) || 0,
                note: document.getElementById('note').value,
                transaction_date: selectedDate
            };

            try {
                const response = await fetch(`${API_BASE}/api/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`✅ ${result.message}. Doanh thu: ${result.data.revenue} xu`);
                    document.getElementById('transactionForm').reset();
                    loadDashboard(); // Refresh dashboard
                    
                    // Refresh history nếu user đang ở tab history
                    const currentTab = document.querySelector('.tab.active');
                    if (currentTab && currentTab.textContent.includes('Lịch Sử')) {
                        loadTransactions();
                    }
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Lỗi khi thêm giao dịch:', error);
                showAlert('Lỗi kết nối. Vui lòng thử lại.', 'error');
            }
        });

        // Load dashboard
        async function loadDashboard() {
            try {
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                const branchId = document.getElementById('dashboard_branch_id')?.value;
                
                // Debug dashboard params
                const url = new URL(`${window.location.origin}/api/dashboard`);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                if (branchId) url.searchParams.append('branch_id', branchId);

                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                


                // Hiển thị stats tổng quan
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h3>${data.total_revenue || 0}</h3>
                        <p>Tổng Doanh Thu (xu)</p>
                    </div>
                    <div class="stat-card">
                        <h3>${data.total_coins_in || 0}</h3>
                        <p>Tổng Xu Vào</p>
                    </div>
                    <div class="stat-card">
                        <h3>${data.total_coins_out || 0}</h3>
                        <p>Tổng Xu Ra</p>
                    </div>
                    <div class="stat-card">
                        <h3>${data.total_machines || 0}</h3>
                        <p>Số Máy Hoạt Động</p>
                    </div>
                `;

                // Hiển thị doanh thu theo chi nhánh (nếu có)
                const machineRevenue = document.getElementById('machine-revenue');
                let revenueHtml = '';
                
                if (data.branches && data.branches.length > 0) {
                    revenueHtml += '<h3>🏢 Doanh Thu Theo Chi Nhánh</h3>';
                    data.branches.forEach(branch => {
                        revenueHtml += `
                            <div class="machine-item branch-item" data-type="branch">
                                <div class="branch-info">
                                    <strong>${branch.branch_name}</strong>
                                    <small style="color: #666;">📍 ${branch.address || 'N/A'}</small>
                                    <small style="color: #888;">👨‍💼 ${branch.manager_name || 'N/A'} • 🎮 ${branch.machine_count || 0} máy</small>
                                </div>
                                <div class="branch-revenue">
                                    <div class="amount">${(branch.total_revenue || 0).toLocaleString()}</div>
                                    <div class="details">${(branch.total_coins_in || 0).toLocaleString()}|${(branch.total_coins_out || 0).toLocaleString()}</div>
                                </div>
                            </div>
                        `;
                    });
                }

                // Hiển thị doanh thu theo máy - LUÔN hiển thị section này
                revenueHtml += '<h3 style="margin-top: 20px;">🎮 Doanh Thu Theo Máy</h3>';
                
                // Fix: đảm bảo data.machines là array
                const machinesArray = Array.isArray(data.machines) ? data.machines : [];
                
                if (machinesArray && machinesArray.length > 0) {
                    
                    // Store dashboard machines để so sánh với recent transactions
                    window.lastDashboardMachines = machinesArray;
                    
                    // Sort machines theo doanh thu giảm dần
                    const sortedMachines = machinesArray.sort((a, b) => (b.total_revenue || 0) - (a.total_revenue || 0));
                    
                    sortedMachines.forEach((machine, index) => {
                        const machineName = machine.machine_name || machine.name || 'Máy không xác định';
                        const location = machine.location || 'Vị trí không xác định';
                        const branchName = machine.branch_name || 'Chi nhánh không xác định';
                        const revenue = machine.total_revenue || 0;
                        const coinsIn = machine.total_coins_in || 0;
                        const coinsOut = machine.total_coins_out || 0;
                        const transactionCount = machine.transaction_count || 0;
                        
                        // Tính tỷ lệ thắng/thua cho máy
                        const winRate = coinsIn > 0 ? ((revenue / coinsIn) * 100).toFixed(1) : '0.0';
                        const revenueClass = revenue > 0 ? '#28a745' : revenue < 0 ? '#dc3545' : '#6c757d';
                        const revenueIcon = revenue > 0 ? '📈' : revenue < 0 ? '📉' : '➖';
                        
                        revenueHtml += `
                            <div class="machine-item" style="margin-bottom: 8px;">
                                <div>
                                    <strong>${machineName}</strong>
                                    <small style="color: #666;">📍 ${location}</small>
                                    <small style="color: #888;">🏢 ${branchName} • 📊 ${transactionCount} GD</small>
                                </div>
                                <div class="revenue-stats">
                                    <div class="revenue-amount" style="color: ${revenueClass};">
                                        ${revenue > 0 ? '+' : ''}${Math.abs(revenue).toLocaleString()}
                                    </div>
                                    <div class="revenue-details">
                                        ${coinsIn.toLocaleString()}|${coinsOut.toLocaleString()}
                                    </div>
                                    <div class="revenue-badge" style="background: ${revenue > 0 ? '#d4edda' : revenue < 0 ? '#f8d7da' : '#e9ecef'}; 
                                                 color: ${revenue > 0 ? '#155724' : revenue < 0 ? '#721c24' : '#495057'};">
                                        ${revenueIcon} ${winRate}%
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // Fallback: Hiển thị danh sách máy hiện có với doanh thu 0
                    revenueHtml += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #dee2e6;">
                            <p style="color: #6c757d; margin: 0; text-align: center;">
                                📊 Chưa có giao dịch nào trong khoảng thời gian này
                            </p>
                        </div>
                        <div style="margin-top: 15px;">
                            <h4 style="color: #666; font-size: 0.95em; margin-bottom: 10px;">📋 Danh sách máy hiện có:</h4>
                            <div id="available-machines-list">
                                <div style="color: #666; font-style: italic;">Đang tải danh sách máy...</div>
                            </div>
                        </div>
                    `;
                    
                    // Load danh sách máy để hiển thị fallback
                    loadAvailableMachinesForDashboard(branchId);
                }
                
                if (!revenueHtml) {
                    const startDate = document.getElementById('start_date').value;
                    const endDate = document.getElementById('end_date').value;
                    const activeQuickFilter = document.querySelector('.quick-filter-btn.active');
                    let periodName = `${startDate} đến ${endDate}`;
                    
                    if (activeQuickFilter) {
                        const period = activeQuickFilter.dataset.period;
                        switch(period) {
                            case 'today': periodName = 'hôm nay'; break;
                            case 'yesterday': periodName = 'hôm qua'; break;
                            case 'week': periodName = '7 ngày qua'; break;
                            case 'month': periodName = 'tháng này'; break;
                        }
                    }
                    
                    revenueHtml = `
                        <div style="text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #dee2e6;">
                            <div style="font-size: 3em; margin-bottom: 15px;">📊</div>
                            <h3 style="color: #6c757d; margin-bottom: 10px;">Chưa có dữ liệu</h3>
                            <p style="color: #6c757d; margin-bottom: 20px;">Không có giao dịch nào trong khoảng thời gian <strong>${periodName}</strong></p>
                            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="showTab('entry')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    ➕ Thêm Giao Dịch
                                </button>
                                <button onclick="setQuickFilter('week')" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    📊 Xem 7 Ngày Qua
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                machineRevenue.innerHTML = revenueHtml;

                // Load thông tin giao dịch gần đây cho manager/admin
                if (currentUser && (currentUser.role === 'manager' || currentUser.role === 'admin')) {
                    await loadRecentTransactionsForDashboard(startDate, endDate, branchId);
                }

            } catch (error) {
                console.error('Lỗi khi load dashboard:', error);
                showAlert('Lỗi khi tải dữ liệu dashboard', 'error');
            }
        }

        // Load danh sách máy để hiển thị khi không có data
        async function loadAvailableMachinesForDashboard(branchId) {
            try {
                let url = `${API_BASE}/api/machines`;
                if (branchId) {
                    url += `?branch_id=${branchId}`;
                }
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const machines = await response.json();
                
                const machinesList = document.getElementById('available-machines-list');
                if (machinesList) {
                    if (machines && machines.length > 0) {
                        let machinesHtml = '';
                        machines.forEach(machine => {
                            machinesHtml += `
                                <div class="machine-item" style="margin-bottom: 8px; opacity: 0.7;">
                                    <div>
                                        <strong>${machine.name}</strong><br>
                                        <small style="color: #666;">📍 ${machine.location} | 🏢 ${machine.branch_name}</small>
                                    </div>
                                    <div style="text-align: right; color: #6c757d;">
                                        <span style="font-size: 0.9em;">Chưa có giao dịch</span>
                                    </div>
                                </div>
                            `;
                        });
                        machinesList.innerHTML = machinesHtml;
                    } else {
                        machinesList.innerHTML = '<div style="color: #999; font-style: italic;">Không có máy nào được tìm thấy</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading available machines:', error);
                const machinesList = document.getElementById('available-machines-list');
                if (machinesList) {
                    machinesList.innerHTML = '<div style="color: #999;">Không thể tải danh sách máy</div>';
                }
            }
        }

        // Load giao dịch gần đây cho Dashboard (Manager/Admin)
        async function loadRecentTransactionsForDashboard(startDate, endDate, branchId) {
            try {
                const url = new URL(`${window.location.origin}/api/transactions`);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                if (branchId) url.searchParams.append('branch_id', branchId);
                url.searchParams.append('limit', '10'); // Chỉ lấy 10 giao dịch gần nhất
                url.searchParams.append('sort_by', 'date_desc');

                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                const transactions = data.transactions || data;
                
                // So sánh machine data để debug inconsistency (development only)
                if (window.lastDashboardMachines && transactions?.length > 0) {
                    const dashboardMachineIds = window.lastDashboardMachines.map(m => m.machine_id || m.id);
                    const recentTransactionMachineIds = [...new Set(transactions.map(t => t.machine_id))];
                    
                    const missingFromDashboard = recentTransactionMachineIds.filter(id => !dashboardMachineIds.includes(id));
                    const missingFromRecent = dashboardMachineIds.filter(id => !recentTransactionMachineIds.includes(id));
                    
                    if (missingFromDashboard.length > 0) {
                        console.log('⚠️ Machines in recent transactions but NOT in dashboard revenue:', missingFromDashboard);
                    }
                    if (missingFromRecent.length > 0) {
                        console.log('⚠️ Machines in dashboard revenue but NOT in recent transactions:', missingFromRecent);
                    }
                }
                
                // Tạo section cho giao dịch gần đây
                const machineRevenue = document.getElementById('machine-revenue');
                
                if (transactions && transactions.length > 0) {
                    // Thống kê nhập liệu
                    let lateCount = 0;
                    let onTimeCount = 0;
                    const lateUsers = {};
                    
                                         transactions.forEach(transaction => {
                         // Nhập muộn = ngày nhập > ngày giao dịch
                         const createdDateStr = new Date(transaction.created_at).toISOString().split('T')[0];
                         const transactionDateStr = transaction.transaction_date;
                         const isLate = createdDateStr > transactionDateStr;
                         if (isLate) {
                             lateCount++;
                             if (transaction.user_name) {
                                 lateUsers[transaction.user_name] = (lateUsers[transaction.user_name] || 0) + 1;
                             }
                         } else {
                             onTimeCount++;
                         }
                     });
                    
                    const latePercentage = transactions.length > 0 ? Math.round((lateCount / transactions.length) * 100) : 0;
                    
                    // Thêm thống kê nhập liệu vào dashboard
                    const entryStatsHtml = `
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 20px;">
                            <h3>⏰ Thống Kê Nhập Liệu (${transactions.length} giao dịch gần nhất)</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
                                <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #c3e6cb;">
                                    <div style="font-size: 1.8em; font-weight: bold; color: #155724;">${onTimeCount}</div>
                                    <div style="color: #155724; font-weight: 600;">Nhập đúng giờ ✅</div>
                                </div>
                                <div style="background: ${lateCount > 0 ? '#f8d7da' : '#e2e3e5'}; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid ${lateCount > 0 ? '#f5c6cb' : '#d6d8db'};">
                                    <div style="font-size: 1.8em; font-weight: bold; color: ${lateCount > 0 ? '#721c24' : '#6c757d'};">${lateCount}</div>
                                    <div style="color: ${lateCount > 0 ? '#721c24' : '#6c757d'}; font-weight: 600;">Nhập muộn ⚠️</div>
                                </div>
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #b3d9ff;">
                                    <div style="font-size: 1.8em; font-weight: bold; color: #0d47a1;">${latePercentage}%</div>
                                    <div style="color: #0d47a1; font-weight: 600;">Tỷ lệ nhập muộn</div>
                                </div>
                            </div>
                            ${Object.keys(lateUsers).length > 0 ? `
                                <div style="margin-top: 15px;">
                                    <strong>👥 Nhân viên nhập muộn:</strong><br>
                                    <div style="margin-top: 8px;">
                                        ${Object.entries(lateUsers).map(([user, count]) => 
                                            `<span style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; margin: 2px; display: inline-block; border: 1px solid #ffeaa7;">${user}: ${count} lần</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Thêm giao dịch gần đây với chi tiết ngày nhập
                    const recentTransactionsHtml = `
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 20px;">
                            <h3>📋 Giao Dịch Gần Đây (Chi Tiết Ngày Nhập)</h3>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${transactions.slice(0, 8).map(transaction => {
                                    const createdTime = new Date(transaction.created_at);
                                    const inputTime = createdTime.toLocaleTimeString('vi-VN', {
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit'
                                    });
                                    const inputDate = createdTime.toLocaleDateString('vi-VN');
                                    const transactionDate = new Date(transaction.transaction_date).toLocaleDateString('vi-VN');
                                    // Nhập muộn = ngày nhập > ngày giao dịch
                                    const createdDateStr = new Date(transaction.created_at).toISOString().split('T')[0];
                                    const transactionDateStr = transaction.transaction_date;
                                    const isLate = createdDateStr > transactionDateStr;
                                    
                                    return `
                                        <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${transaction.revenue >= 0 ? '#28a745' : '#dc3545'};">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                                <div>
                                                    <strong>${transaction.machine_name}</strong><br>
                                                    <small style="color: #666;">📍 ${transaction.location} | 🏢 ${transaction.branch_name}</small><br>
                                                    ${transaction.user_name ? `<small style="color: #666;">👤 ${transaction.user_name}</small>` : ''}
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-size: 1.1em; font-weight: bold; color: ${transaction.revenue >= 0 ? '#28a745' : '#dc3545'};">
                                                        ${transaction.revenue > 0 ? '+' : ''}${transaction.revenue} xu
                                                    </div>
                                                    <small style="color: #666;">Vào: ${transaction.coins_in} | Ra: ${transaction.coins_out}</small>
                                                </div>
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                                                <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid #2196f3;">
                                                    📅 <strong>Ngày GD:</strong> ${transactionDate}
                                                </span>
                                                <span style="background: ${isLate ? '#fff3cd' : '#d4edda'}; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid ${isLate ? '#ffeaa7' : '#c3e6cb'}; ${isLate ? 'color: #ff6b35; font-weight: bold;' : ''}">
                                                    ⏰ <strong>Nhập:</strong> ${inputDate} ${inputTime} ${isLate ? '⚠️' : '✅'}
                                                </span>
                                                ${transaction.note ? `<span style="background: #e7f3ff; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid #b3d9ff;">📝 ${transaction.note}</span>` : ''}
                                            </div>
                                                                                         ${isLate ? `<div style="color: #ff6b35; font-size: 0.85em; margin-top: 8px; background: #fff3cd; padding: 6px; border-radius: 4px; border-left: 3px solid #ff6b35;">⚠️ <strong>Nhập muộn:</strong> Giao dịch ngày ${transactionDate} được nhập vào ngày ${inputDate}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="showTab('history')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">📋 Xem Tất Cả Lịch Sử</button>
                            </div>
                        </div>
                    `;
                    
                    // Thêm vào cuối machine revenue
                    machineRevenue.innerHTML += entryStatsHtml + recentTransactionsHtml;
                }

            } catch (error) {
                console.error('Lỗi khi load giao dịch gần đây:', error);
            }
        }

        // Load danh sách users cho manager
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/api/users`, {
                    credentials: 'include'
                });
                const users = await response.json();
                
                const select = document.getElementById('history_user_id');
                if (select) {
                    select.innerHTML = '<option value="">-- Tất cả nhân viên --</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.full_name} (${user.username})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Lỗi khi load users:', error);
            }
        }

        // Clear history filters
        function clearHistoryFilters() {
            const today = new Date().toISOString().split('T')[0];
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('filter_machine').value = '';
            document.getElementById('history_user_id').value = '';
            document.getElementById('history_start_date').value = sevenDaysAgo;
            document.getElementById('history_end_date').value = today;
            document.getElementById('sort_by').value = 'date_desc';
            
            if (document.getElementById('history_branch_id')) {
                document.getElementById('history_branch_id').value = '';
            }
            
            // Reset late entry filter
            if (document.getElementById('filter_late_entry')) {
                document.getElementById('filter_late_entry').value = '';
            }
            
            // Reset user selector nếu có
            if (document.getElementById('history_user_id')) {
                document.getElementById('history_user_id').value = '';
            }
            
            loadTransactions();
        }

        // Load lịch sử giao dịch với filter nâng cao
        async function loadTransactions() {
            try {
                const machineId = document.getElementById('filter_machine').value;
                const branchId = document.getElementById('history_branch_id')?.value;
                const userId = document.getElementById('history_user_id')?.value;
                const startDate = document.getElementById('history_start_date').value;
                const endDate = document.getElementById('history_end_date').value;
                const sortBy = document.getElementById('sort_by').value;
                const lateEntryFilter = document.getElementById('filter_late_entry')?.value;
                
                // Debug current user and filter params
                console.log('🔍 loadTransactions DEBUG:');
                console.log('Current User:', currentUser);
                console.log('Filter params:', { machineId, branchId, userId, startDate, endDate, sortBy });
                
                const url = new URL(`${window.location.origin}/api/transactions`);
                if (machineId) url.searchParams.append('machine_id', machineId);
                if (branchId) url.searchParams.append('branch_id', branchId);
                if (userId) url.searchParams.append('user_id', userId);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                if (sortBy) url.searchParams.append('sort_by', sortBy);
                url.searchParams.append('limit', '50');

                console.log('🌐 API URL:', url.toString());

                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                console.log('📦 API Response:', data);
                console.log('📦 Data type:', typeof data);
                console.log('📦 Is Array:', Array.isArray(data));
                
                // Hiển thị summary
                displayHistorySummary(data.summary || {});
                
                let transactions = data.transactions || data;
                console.log('📦 Transactions:', transactions);
                console.log('📦 Transactions length:', transactions?.length);
                
                // Thống kê late entry cho manager/admin
                if (currentUser && (currentUser.role === 'manager' || currentUser.role === 'admin')) {
                    displayLateEntryStats(transactions);
                }
                
                // Filter theo late entry nếu cần
                if (lateEntryFilter) {
                    transactions = transactions.filter(transaction => {
                        // Nhập muộn = ngày nhập dữ liệu > ngày giao dịch
                        const createdDateStr = transaction.created_at.split('T')[0];
                        const transactionDateStr = transaction.transaction_date;
                        const isLate = createdDateStr > transactionDateStr;
                        if (lateEntryFilter === 'late') return isLate;
                        if (lateEntryFilter === 'ontime') return !isLate;
                        return true;
                    });
                }
                
                const historyContainer = document.getElementById('transaction-history');
                
                if (transactions.length > 0) {
                    // Group transactions by date
                    const groupedTransactions = groupTransactionsByDate(transactions);
                    let historyHtml = '';
                    
                    Object.keys(groupedTransactions).forEach(date => {
                        const dayTransactions = groupedTransactions[date];
                        const dayTotal = dayTransactions.reduce((sum, t) => sum + t.revenue, 0);
                        
                        historyHtml += `
                            <div class="date-group">
                                <h3>📅 ${formatDateVN(date)} - Tổng: <span style="color: ${dayTotal >= 0 ? '#28a745' : '#dc3545'};">${dayTotal} xu</span></h3>
                            </div>
                        `;
                        
                        dayTransactions.forEach(transaction => {
                            // Debug log để kiểm tra dữ liệu
                            console.log('🔍 Processing transaction:', transaction);
                            
                            const createdTime = new Date(transaction.created_at);
                            const inputTime = createdTime.toLocaleTimeString('vi-VN', {
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            const inputDate = createdTime.toLocaleDateString('vi-VN');
                            const transactionDate = new Date(transaction.transaction_date).toLocaleDateString('vi-VN');
                            
                            // Kiểm tra xem có nhập muộn không
                            // Nhập muộn = ngày nhập dữ liệu > ngày giao dịch
                            // Ví dụ: GD ngày 23/6 nhưng nhập vào ngày 24/6 = nhập muộn
                            const transactionDateStr = transaction.transaction_date; // yyyy-mm-dd
                            const createdDateStr = transaction.created_at.split('T')[0]; // yyyy-mm-dd từ timestamp
                            const isLateEntry = createdDateStr > transactionDateStr;
                            
                            console.log(`📅 Transaction Date: ${transactionDateStr}`);
                            console.log(`⏰ Created At: ${transaction.created_at}`);
                            console.log(`⏰ Created Date: ${createdDateStr}`);
                            console.log(`⏰ Input Date: ${inputDate}`);
                            console.log(`🔍 Is Late Entry: ${isLateEntry} (created: ${createdDateStr} > transaction: ${transactionDateStr})`);
                            
                            historyHtml += `
                                <div class="transaction-item">
                                    <div class="transaction-header">
                                        <div class="transaction-info">
                                            <h4>${transaction.machine_name}</h4>
                                            <div class="meta">
                                                📍 ${transaction.location} | 🏢 ${transaction.branch_name}<br>
                                                ${transaction.user_name ? `👤 ${transaction.user_name}` : ''}
                                            </div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="revenue" style="color: ${transaction.revenue >= 0 ? '#28a745' : '#dc3545'};">
                                                ${transaction.revenue > 0 ? '+' : ''}${transaction.revenue} xu
                                            </div>
                                            <div class="coins">
                                                Vào: ${transaction.coins_in} | Ra: ${transaction.coins_out}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="transaction-footer">
                                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 5px 0;">
                                            <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; border: 1px solid #2196f3;">
                                                📅 <strong>Ngày GD:</strong> ${transactionDate}
                                            </span>
                                            <span style="background: ${isLateEntry ? '#fff3cd' : '#d4edda'}; padding: 4px 8px; border-radius: 4px; border: 1px solid ${isLateEntry ? '#ffeaa7' : '#c3e6cb'}; ${isLateEntry ? 'color: #ff6b35; font-weight: bold;' : ''}">
                                                ⏰ <strong>Nhập lúc:</strong> ${inputDate} ${inputTime}
                                                ${isLateEntry ? ' ⚠️' : ' ✅'}
                                            </span>
                                            ${transaction.note ? `<span style="background: #e7f3ff; padding: 4px 8px; border-radius: 4px; border: 1px solid #b3d9ff;">📝 ${transaction.note}</span>` : ''}
                                        </div>
                                        ${isLateEntry ? `<div style="color: #ff6b35; font-size: 0.9em; margin-top: 5px; background: #fff3cd; padding: 8px; border-radius: 4px; border-left: 4px solid #ff6b35;">⚠️ <strong>Nhập muộn:</strong> Giao dịch ngày ${transactionDate} được nhập vào ngày ${inputDate}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    });
                    
                    historyContainer.innerHTML = historyHtml;
                } else {
                    historyContainer.innerHTML = '<p>Không tìm thấy giao dịch nào phù hợp với bộ lọc.</p>';
                }

            } catch (error) {
                console.error('Lỗi khi load lịch sử:', error);
                showAlert('Lỗi khi tải lịch sử giao dịch', 'error');
            }
        }

        // Group transactions by date
        function groupTransactionsByDate(transactions) {
            const grouped = {};
            transactions.forEach(transaction => {
                const date = transaction.transaction_date || transaction.created_at.split('T')[0];
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(transaction);
            });
            return grouped;
        }

        // Format date in Vietnamese
        function formatDateVN(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            if (dateStr === today.toISOString().split('T')[0]) {
                return 'Hôm nay (' + date.toLocaleDateString('vi-VN') + ')';
            } else if (dateStr === yesterday.toISOString().split('T')[0]) {
                return 'Hôm qua (' + date.toLocaleDateString('vi-VN') + ')';
            } else {
                return date.toLocaleDateString('vi-VN');
            }
        }

        // Hiển thị thống kê late entry cho manager/admin
        function displayLateEntryStats(transactions) {
            if (!transactions || transactions.length === 0) return;
            
            let lateCount = 0;
            let onTimeCount = 0;
            const lateUsers = {};
            
            transactions.forEach(transaction => {
                // Nhập muộn = ngày nhập dữ liệu > ngày giao dịch
                const createdDateStr = transaction.created_at.split('T')[0];
                const transactionDateStr = transaction.transaction_date;
                const isLate = createdDateStr > transactionDateStr;
                if (isLate) {
                    lateCount++;
                    if (transaction.user_name) {
                        lateUsers[transaction.user_name] = (lateUsers[transaction.user_name] || 0) + 1;
                    }
                } else {
                    onTimeCount++;
                }
            });
            
            const latePercentage = transactions.length > 0 ? Math.round((lateCount / transactions.length) * 100) : 0;
            
            // Tạo late entry summary
            const existingSummary = document.getElementById('history-summary');
            const lateEntryHtml = `
                <div style="background: ${lateCount > 0 ? '#fff3cd' : '#d4edda'}; border: 1px solid ${lateCount > 0 ? '#ffeaa7' : '#c3e6cb'}; border-radius: 8px; padding: 15px; margin: 15px 0;">
                    <h3>⏰ Thống Kê Nhập Liệu</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 10px 0;">
                        <div style="text-align: center; background: #d4edda; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #155724;">${onTimeCount}</div>
                            <div style="color: #155724;">Nhập đúng giờ ✅</div>
                        </div>
                        <div style="text-align: center; background: ${lateCount > 0 ? '#f8d7da' : '#e2e3e5'}; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: ${lateCount > 0 ? '#721c24' : '#6c757d'};">${lateCount}</div>
                            <div style="color: ${lateCount > 0 ? '#721c24' : '#6c757d'};">Nhập muộn ⚠️</div>
                        </div>
                        <div style="text-align: center; background: #e3f2fd; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #0d47a1;">${latePercentage}%</div>
                            <div style="color: #0d47a1;">Tỷ lệ nhập muộn</div>
                        </div>
                    </div>
                    ${Object.keys(lateUsers).length > 0 ? `
                        <div style="margin-top: 10px;">
                            <strong>👥 Nhân viên nhập muộn:</strong><br>
                            ${Object.entries(lateUsers).map(([user, count]) => 
                                `<span style="background: #fff3cd; padding: 2px 6px; border-radius: 4px; margin: 2px; display: inline-block;">${user}: ${count} lần</span>`
                            ).join('')}
                        </div>
                    ` : ''}
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        💡 <strong>Tip:</strong> Sử dụng filter "Lọc Nhập Muộn" để xem chi tiết các giao dịch nhập muộn.
                    </div>
                </div>
            `;
            
            // Remove existing late entry stats nếu có
            const existingLateStats = document.querySelector('.late-entry-stats');
            if (existingLateStats) {
                existingLateStats.remove();
            }
            
            // Thêm vào sau existing summary
            if (existingSummary) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = lateEntryHtml.replace('<div style=', '<div class="late-entry-stats" style=');
                existingSummary.parentNode.insertBefore(tempDiv.firstElementChild, existingSummary.nextSibling);
            }
        }

        // Display history summary
        function displayHistorySummary(summary) {
            const summaryContainer = document.getElementById('history-summary');
            if (!summary || Object.keys(summary).length === 0) {
                summaryContainer.style.display = 'none';
                return;
            }
            
            summaryContainer.style.display = 'block';
            summaryContainer.innerHTML = `
                <h3>📊 Tổng Quan Kết Quả Tìm Kiếm</h3>
                <div class="summary-stats">
                    <div class="summary-card">
                        <h4>${summary.total_transactions || 0}</h4>
                        <p>Tổng Giao Dịch</p>
                    </div>
                    <div class="summary-card">
                        <h4>${summary.total_revenue || 0}</h4>
                        <p>Tổng Doanh Thu (xu)</p>
                    </div>
                    <div class="summary-card">
                        <h4>${summary.total_coins_in || 0}</h4>
                        <p>Tổng Xu Vào</p>
                    </div>
                    <div class="summary-card">
                        <h4>${summary.total_coins_out || 0}</h4>
                        <p>Tổng Xu Ra</p>
                    </div>
                </div>
            `;
        }

        // Debug function cho manager/admin
        function debugTransactions() {
            console.log('🔧 Debug Mode - Current User:', currentUser);
            console.log('🔧 Checking UI elements...');
            
            const elements = [
                'history_user_selector',
                'late_entry_filter', 
                'filter_late_entry',
                'history_user_id'
            ];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                console.log(`🔧 Element ${id}:`, el ? 'EXISTS' : 'NOT FOUND', el?.style.display || 'default');
            });
            
            // Test load transactions
            console.log('🔧 Testing loadTransactions...');
            loadTransactions();
        }

        // Tạo test data cho manager
        async function createTestData() {
            if (!confirm('Tạo dữ liệu test? (Sẽ thêm giao dịch cho ngày hôm qua - được đánh dấu là NHẬP MUỘN)')) return;
            
            try {
                // Tạo giao dịch của hôm qua nhưng nhập hôm nay = nhập muộn
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                const testData = {
                    machine_id: 1, // Máy đầu tiên trong chi nhánh
                    coins_in: 8000,
                    coins_out: 6500,
                    note: `TEST: Giao dịch ngày ${yesterdayStr} - đánh dấu nhập muộn`,
                    transaction_date: yesterdayStr // Giao dịch hôm qua = nhập muộn theo logic mới
                };

                const response = await fetch(`${API_BASE}/api/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`✅ Đã tạo test data: ${result.message}. ⚠️ Đây là giao dịch NHẬP MUỘN!`);
                    loadTransactions(); // Reload để thấy data mới
                    loadDashboard(); // Reload dashboard để thấy stats mới
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Lỗi tạo test data:', error);
                showAlert('Lỗi khi tạo test data', 'error');
            }
        }

        // Export current filtered data to Excel
        async function exportCurrentData() {
            try {
                // Get current filter values
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                const branchId = document.getElementById('dashboard_branch_id')?.value;
                
                // Determine period for filename
                let periodName = '';
                const activeQuickFilter = document.querySelector('.quick-filter-btn.active');
                if (activeQuickFilter) {
                    const period = activeQuickFilter.dataset.period;
                    switch(period) {
                        case 'today': periodName = 'hom-nay'; break;
                        case 'yesterday': periodName = 'hom-qua'; break;
                        case 'week': periodName = '7-ngay-qua'; break;
                        case 'month': periodName = 'thang-nay'; break;
                        default: periodName = `${startDate}-${endDate}`;
                    }
                } else {
                    periodName = `${startDate}-${endDate}`;
                }
                
                // Show loading state
                const exportBtn = document.querySelector('#export_section button');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '⏳ Đang xuất...';
                exportBtn.disabled = true;
                
                const url = new URL(`${window.location.origin}/api/export/csv`);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                if (branchId) url.searchParams.append('branch_id', branchId);

                console.log('📄 Export URL:', url.toString());

                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (response.ok) {
                    // Tạo blob từ response
                    const blob = await response.blob();
                    
                    // Tạo URL download
                    const downloadUrl = window.URL.createObjectURL(blob);
                    
                    // Tạo link download và click
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `doanh-thu-${periodName}-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);
                    
                    showAlert(`✅ Xuất file Excel thành công! Khoảng thời gian: ${startDate} đến ${endDate}`);
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Lỗi khi xuất file', 'error');
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showAlert('Lỗi khi xuất file Excel', 'error');
            } finally {
                // Restore button state
                const exportBtn = document.querySelector('#export_section button');
                exportBtn.innerHTML = '📄 Export Excel';
                exportBtn.disabled = false;
            }
        }

        // Debug function cho Admin
        async function debugTransactions() {
            try {
                const response = await fetch('/api/transactions?limit=10', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                console.log('🔧 DEBUG - Raw transaction data:', data);
                
                const transactions = data.transactions || data;
                if (transactions.length === 0) {
                    alert('❌ Không có dữ liệu giao dịch nào!\n\nHãy tạo dữ liệu test:\n1. Login nhân viên (nv001/123456)\n2. Tạo giao dịch với ngày khác nhau\n3. Quay lại Admin để xem');
                    return;
                }
                
                let debugInfo = '🔧 DEBUG INFO:\n\n';
                transactions.slice(0, 3).forEach((t, i) => {
                    debugInfo += `Giao dịch ${i+1}:\n`;
                    debugInfo += `- Machine: ${t.machine_name}\n`;
                    debugInfo += `- User: ${t.user_name}\n`;
                    debugInfo += `- Transaction Date: ${t.transaction_date}\n`;
                    debugInfo += `- Created At: ${t.created_at}\n`;
                    debugInfo += `- Late Entry: ${t.transaction_date !== t.created_at.split('T')[0] ? 'YES ⚠️' : 'NO ✅'}\n\n`;
                });
                
                alert(debugInfo);
                
            } catch (error) {
                console.error('Debug error:', error);
                alert('❌ Lỗi debug: ' + error.message);
            }
        }

        // Reset dữ liệu chi nhánh (chỉ dành cho Manager)
        async function resetData() {
            try {
                // Xác nhận trước khi reset
                const branchName = currentUser.branch_name || 'chi nhánh này';
                const confirmMessage = `⚠️ CẢNH BÁO: Bạn có chắc chắn muốn XÓA TOÀN BỘ dữ liệu giao dịch của ${branchName}?\n\n` +
                                     `Hành động này KHÔNG THỂ HOÀN TÁC!\n\n` +
                                     `Nhập "XAC NHAN" để tiếp tục:`;
                
                const userInput = prompt(confirmMessage);
                
                if (userInput !== 'XAC NHAN') {
                    showAlert('❌ Đã hủy thao tác reset dữ liệu');
                    return;
                }

                // Hiển thị loading
                const resetButton = document.querySelector('#reset_section button');
                const originalText = resetButton.innerHTML;
                resetButton.innerHTML = '⏳ Đang reset...';
                resetButton.disabled = true;

                const response = await fetch('/api/reset-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(`✅ ${result.message}`, 'success');
                    
                    // Reload dữ liệu để cập nhật giao diện
                    loadDashboard();
                    loadTransactions();
                } else {
                    showAlert(result.error || 'Lỗi khi reset dữ liệu', 'error');
                }

            } catch (error) {
                console.error('Error resetting data:', error);
                showAlert('Lỗi khi reset dữ liệu', 'error');
            } finally {
                // Khôi phục button
                const resetButton = document.querySelector('#reset_section button');
                resetButton.innerHTML = '🗑️ Reset Dữ Liệu';
                resetButton.disabled = false;
            }
        }
    </script>
</body>
</html> 